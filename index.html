
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA Team Dashboard</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-color: #1a2526;
            --widget-background: #2e3f52;
            --text-color: #f5f5f5;
            --shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            --border-radius: 6px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background-color: var(--background-color);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: width 0.3s;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar.collapsed .sidebar-item span {
            display: none;
        }

        .sidebar.collapsed .sidebar-item {
            justify-content: center;
            position: relative;
        }

        .sidebar.collapsed .sidebar-item.active {
            background-color: var(--primary-color);
            color: #fff;
            border-radius: var(--border-radius);
            width: 40px;
            height: 40px;
        }

        .sidebar-item {
            padding: 14px 18px;
            margin-bottom: 10px;
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: background-color 0.3s;
            color: var(--text-color);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-item:hover,
        .sidebar-item.active {
            background-color: var(--primary-color);
            color: #fff;
        }

        .sidebar-toggle {
            font-size: 20px;
            cursor: pointer;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .main-content {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
        }

        .breadcrumbs {
            margin-bottom: 15px;
            font-size: 12px;
            color: var(--secondary-color);
        }

        .breadcrumbs a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background-color: var(--widget-background);
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            border-radius: var(--border-radius);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-left img {
            height: 40px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 14px;
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 12px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 12px;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-danger {
            background-color: #dc3545;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 12px;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .loader-container {
            --uib-size: 40px;
            --uib-color: white;
            --uib-speed: .9s;
            --uib-center: calc(var(--uib-size) / 2 - var(--uib-size) / 5 / 2);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            align-items: center;
            justify-content: flex-start;
            height: var(--uib-size);
            width: var(--uib-size);
            animation: rotate calc(var(--uib-speed) * 3) linear infinite;
            z-index: 1002;
        }

        .dot {
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            height: 100%;
            width: 100%;
        }

        .dot::before {
            content: '';
            height: 20%;
            width: 20%;
            border-radius: 50%;
            background-color: var(--uib-color);
            animation: oscillate var(--uib-speed) ease-in-out infinite alternate;
        }

        .dot:nth-child(1)::before { transform: translateX(var(--uib-center)); }
        .dot:nth-child(2) { transform: rotate(45deg); }
        .dot:nth-child(2)::before { transform: translateX(var(--uib-center)); animation-delay: calc(var(--uib-speed) * -0.125); }
        .dot:nth-child(3) { transform: rotate(90deg); }
        .dot:nth-child(3)::before { transform: translateX(var(--uib-center)); animation-delay: calc(var(--uib-speed) * -0.25); }
        .dot:nth-child(4) { transform: rotate(135deg); }
        .dot:nth-child(4)::before { transform: translateX(var(--uib-center)); animation-delay: calc(var(--uib-speed) * -0.375); }
        .dot:nth-child(5) { transform: rotate(180deg); }
        .dot:nth-child(5)::before { transform: translateX(var(--uib-center)); animation-delay: calc(var(--uib-speed) * -0.5); }
        .dot:nth-child(6) { transform: rotate(225deg); }
        .dot:nth-child(6)::before { transform: translateX(var(--uib-center)); animation-delay: calc(var(--uib-speed) * -0.625); }
        .dot:nth-child(7) { transform: rotate(270deg); }
        .dot:nth-child(7)::before { transform: translateX(var(--uib-center)); animation-delay: calc(var(--uib-speed) * -0.75); }
        .dot:nth-child(8) { transform: rotate(315deg); }
        .dot:nth-child(8)::before { transform: translateX(var(--uib-center)); animation-delay: calc(var(--uib-speed) * -0.875); }

        @keyframes oscillate {
            0% { transform: translateX(var(--uib-center)) scale(0); opacity: 0.25; }
            100% { transform: translateX(0) scale(1); opacity: 1; }
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .widget {
            background-color: var(--widget-background);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            margin-top: 25px;
        }

        .widget h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }

        .stats {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .stats-number {
            font-size: 32px;
            font-weight: bold;
            color: var(--text-color);
        }

        .stats-list {
            font-size: 14px;
        }

        .stats-list-item {
            margin-bottom: 10px;
        }

        .kanban-board {
            display: flex;
            gap: 25px;
        }

        .kanban-column {
            flex: 1;
            background-color: var(--widget-background);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            min-height: 300px;
        }

        .kanban-column.todo { border-left: 4px solid #ffc107; }
        .kanban-column.in-progress { border-left: 4px solid #fd7e14; }
        .kanban-column.done { border-left: 4px solid #28a745; }
        .kanban-column.dragover { background-color: #3b4d64; }

        .kanban-column h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .table-container {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: auto;
            position: relative;
            width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--widget-background);
            box-shadow: var(--shadow);
            border-radius: var(--border-radius);
            table-layout: auto;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #444;
            font-size: 12px;
            color: var(--text-color);
            white-space: normal;
            word-wrap: break-word;
            min-width: 100px;
        }

        th {
            background-color: var(--primary-color);
            color: #fff;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            padding: 10px 16px;
            position: sticky;
            top: 0;
            z-index: 2;
            cursor: pointer;
        }

        th:hover {
            background-color: #0056b3;
        }

        th:nth-child(1),
        th:nth-child(2),
        td:nth-child(1),
        td:nth-child(2) {
            position: sticky;
            left: 0;
            background-color: var(--primary-color);
            z-index: 1;
        }

        td:nth-child(1),
        td:nth-child(2) {
            background-color: #34495e;
        }

        tr:nth-child(even) td:nth-child(1),
        tr:nth-child(even) td:nth-child(2) {
            background-color: #3e5c76;
        }

        tr:hover td:nth-child(1),
        tr:hover td:nth-child(2) {
            background-color: #4a6a8a;
        }

        td {
            background-color: #34495e;
        }

        tr:nth-child(even) td {
            background-color: #3e5c76;
        }

        tr:hover td {
            background-color: #4a6a8a;
        }

        td select, td input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 12px;
            width: 100%;
            background-color: #fff;
            color: #333;
            box-sizing: border-box;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--widget-background);
            padding: 25px;
            border-radius: var(--border-radius);
            width: 450px;
            max-width: 90%;
            position: relative;
            color: var(--text-color);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            cursor: pointer;
            font-size: 24px;
            color: var(--text-color);
        }

        .notification {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--primary-color);
            color: #fff;
            padding: 12px 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            font-size: 14px;
            z-index: 1001;
        }

        .error-notification {
            background-color: #dc3545;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-size: 12px;
            color: var(--text-color);
        }

        .form-group label.required::after {
            content: '*';
            color: #dc3545;
            margin-left: 4px;
        }

        input, select, textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 12px;
            width: 100%;
            background-color: #fff;
            color: #333;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 4px var(--primary-color);
        }

        select {
            appearance: none;
            background: url('data:image/svg+xml;utf8,<svg fill="gray" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 10px center;
            background-size: 16px;
        }

        .list-item {
            background-color: var(--widget-background);
            padding: 14px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .category-item {
            background-color: var(--widget-background);
            padding: 14px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .subcategory-list {
            margin-left: 25px;
            margin-bottom: 25px;
        }

        .subcategory-item {
            background-color: #34495e;
            padding: 10px;
            margin-bottom: 6px;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        h2 {
            font-size: 24px;
            margin-bottom: 25px;
            color: var(--text-color);
        }

        .search-bar {
            margin-bottom: 20px;
        }

        .search-bar input {
            padding: 10px;
            width: 100%;
            max-width: 300px;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                padding: 10px;
            }

            .sidebar.collapsed {
                width: 50px;
                position: fixed;
                height: 100%;
                z-index: 100;
            }

            .main-content {
                padding: 15px;
                margin-left: 0;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .header-right {
                flex-direction: column;
                align-items: flex-start;
            }

            .kanban-board {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .table-container {
                max-height: 300px;
            }

            th, td {
                min-width: 80px;
            }

            .modal-content {
                width: 90%;
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            .sidebar-toggle {
                font-size: 16px;
            }

            .sidebar-item {
                padding: 10px;
                font-size: 12px;
            }

            .header-left img {
                height: 30px;
            }

            .btn-primary, .btn-danger {
                padding: 8px 15px;
                font-size: 10px;
            }

            h2 {
                font-size: 18px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 10px;
            }
        }

        #standup-form {
            margin-bottom: 25px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</div>
            <div class="sidebar-item active" data-tab="dashboard"><span>üìä Dashboard</span></div>
            <div class="sidebar-item" data-tab="daily-standup"><span>üìÖ Daily Standup</span></div>
            <div class="sidebar-item" data-tab="kanban-board"><span>üìã Scrum Board</span></div>
            <div class="sidebar-item team-lead-only" data-tab="project-management"><span>üèóÔ∏è Projects</span></div>
            <div class="sidebar-item" data-tab="project-overview"><span>üîç Project Overview</span></div>
            <div class="sidebar-item" data-tab="approved-projects"><span>‚úÖ Approved Projects</span></div>
            <div class="sidebar-item" data-tab="rejected-projects"><span>‚ùå Rejected Projects</span></div>
            <div class="sidebar-item team-lead-admin" data-tab="project-types"><span>üìë Project Types</span></div>
            <div class="sidebar-item team-lead-admin" data-tab="qa-report"><span>üìà QA Report</span></div>
            <div class="sidebar-item team-lead-only" data-tab="activity-log"><span>üïí Activity Log</span></div>
            <div class="sidebar-item" data-tab="profile"><span>üë§ Profile</span></div>
            <div class="sidebar-item team-lead-only" data-tab="user-management"><span>üë• User Management</span></div>
            <div class="sidebar-item team-lead-only" data-tab="assign-roles"><span>üîë Assign Roles</span></div>
        </div>
        <div class="main-content">
            <div class="header">
                <div class="header-left">
                    <img src="images/logo.png" alt="Intersmart Logo">
                    <span style="font-size: 16px; font-weight: bold;">QA Team Dashboard</span>
                </div>
                <div class="header-right">
                    <div class="user-avatar" id="user-avatar"></div>
                    <span id="user-name"></span>
                    <button class="btn-primary" onclick="logout()">Logout</button>
                </div>
            </div>
            <div class="breadcrumbs" id="breadcrumbs"></div>
            <div id="notification" class="notification"></div>
            <div id="loader" class="loader-container">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
            <div id="dashboard" class="tab-pane active">
                <h2>Welcome, <span id="welcome-user"></span>!</h2>
                <div id="dashboard-content" class="stats-grid"></div>
            </div>
            <div id="daily-standup" class="tab-pane">
                <h2>Daily Standup</h2>
                <form id="standup-form">
                    <div class="form-group">
                        <label for="standup-yesterday" class="required">Yesterday‚Äôs Work</label>
                        <input type="text" id="standup-yesterday" placeholder="What did you do yesterday?" required>
                    </div>
                    <div class="form-group">
                        <label for="standup-today" class="required">Today‚Äôs Plan</label>
                        <input type="text" id="standup-today" placeholder="What will you do today?" required>
                    </div>
                    <div class="form-group">
                        <label for="standup-blockers">Blockers</label>
                        <input type="text" id="standup-blockers" placeholder="Any blockers?">
                    </div>
                    <button type="submit" class="btn-primary">Submit Standup</button>
                </form>
                <div class="widget team-lead-admin" style="margin-bottom: 25px;">
                    <h3>Search Standups (Admin Only)</h3>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <input type="date" id="standup-search-date" onchange="renderStandup()">
                        <div class="form-group" style="display: flex; gap: 10px;">
                            <label for="standup-export-from">Export From:</label>
                            <input type="date" id="standup-export-from">
                        </div>
                        <div class="form-group" style="display: flex; gap: 10px;">
                            <label for="standup-export-to">To:</label>
                            <input type="date" id="standup-export-to">
                        </div>
                        <button class="btn-primary" onclick="exportStandupData()">Export Standups</button>
                    </div>
                </div>
                <div class="widget">
                    <h3>Recent Standups (Last 2 Weeks)</h3>
                    <div class="table-container">
                        <table id="standup-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>User</th>
                                    <th>Yesterday‚Äôs Work</th>
                                    <th>Today‚Äôs Plan</th>
                                    <th>Blockers</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="kanban-board" class="tab-pane">
                <h2>Scrum Board</h2>
                <button class="btn-primary" onclick="showTaskForm()" style="margin-bottom: 25px;">Add Task</button>
                <div class="kanban-board">
                    <div class="kanban-column todo" ondrop="drop(event, 'To Do')" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                        <h3>To Do</h3>
                        <div id="to-do-tasks"></div>
                    </div>
                    <div class="kanban-column in-progress" ondrop="drop(event, 'In Progress')" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                        <h3>In Progress</h3>
                        <div id="in-progress-tasks"></div>
                    </div>
                    <div class="kanban-column done" ondrop="drop(event, 'Done')" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                        <h3>Done</h3>
                        <div id="done-tasks"></div>
                    </div>
                </div>
            </div>
            <div id="project-management" class="tab-pane team-lead-only">
                <h2>Projects</h2>
                <button class="btn-primary" onclick="showProjectForm()" style="margin-bottom: 25px;">Create Project</button>
                <div id="projects-list"></div>
            </div>
            <div id="project-overview" class="tab-pane">
                <h2>Project Overview</h2>
                <div class="search-bar">
                    <input type="text" id="project-search" placeholder="Search by project name, type, or status" onkeyup="filterProjects()">
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)">Project Name</th>
                                <th onclick="sortTable(1)">Assigned QA</th>
                                <th onclick="sortTable(2)">Project Type</th>
                                <th onclick="sortTable(3)">Current Phase</th>
                                <th onclick="sortTable(4)">KT Received</th>
                                <th onclick="sortTable(5)">Start Date</th>
                                <th onclick="sortTable(6)">End Date</th>
                                <th onclick="sortTable(7)">Status</th>
                                <th>Submit for TL Approval</th>
                                <th onclick="sortTable(8)">Approved for Live?</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="project-overview-table"></tbody>
                    </table>
                </div>
            </div>
            <div id="approved-projects" class="tab-pane">
                <h2>Approved Projects</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Project Name</th>
                                <th>Assigned QA</th>
                                <th>Project Type</th>
                                <th>Current Phase</th>
                                <th>KT Received</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                                <th>Approved Date</th>
                            </tr>
                        </thead>
                        <tbody id="approved-projects-table"></tbody>
                    </table>
                </div>
            </div>
            <div id="rejected-projects" class="tab-pane">
                <h2>Rejected Projects</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Project Name</th>
                                <th>Assigned QA</th>
                                <th>Project Type</th>
                                <th>Current Phase</th>
                                <th>KT Received</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                                <th>Rejection Date</th>
                                <th>Rejection Reason</th>
                                <th>Rejected By</th>
                            </tr>
                        </thead>
                        <tbody id="rejected-projects-table"></tbody>
                    </table>
                </div>
            </div>
            <div id="project-types" class="tab-pane team-lead-admin">
                <h2>Project Types</h2>
                <button class="btn-primary" onclick="showCategoryForm()" style="margin-bottom: 25px;">Add Category</button>
                <div id="project-types-list"></div>
                <h2>Testing Phases</h2>
                <button class="btn-primary" onclick="showPhaseForm()" style="margin-bottom: 25px;">Add Testing Phase</button>
                <div id="testing-phases-list"></div>
            </div>
            <div id="qa-report" class="tab-pane team-lead-admin">
                <h2>QA Report</h2>
                <div class="filters" style="display: flex; gap: 15px; margin-bottom: 25px;">
                    <input type="date" id="report-filter-date">
                    <select id="report-filter-qa"></select>
                    <select id="report-filter-project"></select>
                    <select id="report-filter-type"></select>
                    <button class="btn-primary" onclick="renderReports()">Apply Filters</button>
                    <button class="btn-primary" onclick="exportReport()">Export Report</button>
                </div>
                <div id="reports-list">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Project Name</th>
                                    <th>QA</th>
                                    <th>Type</th>
                                    <th>Phase</th>
                                    <th>Status</th>
                                    <th>Approved?</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="activity-log" class="tab-pane team-lead-only">
                <h2>Activity Log</h2>
                <div id="activity-log-list"></div>
            </div>
            <div id="profile" class="tab-pane">
                <h2>Profile</h2>
                <form id="profile-form">
                    <div class="form-group">
                        <label for="profile-name" class="required">Your Name</label>
                        <input type="text" id="profile-name" placeholder="Enter your name" required>
                    </div>
                    <div class="form-group">
                        <label for="profile-email" class="required">Email</label>
                        <input type="email" id="profile-email" required>
                    </div>
                    <div class="form-group">
                        <label for="profile-password">New Password</label>
                        <input type="password" id="profile-password" placeholder="Leave blank to keep current password">
                    </div>
                    <button type="submit" class="btn-primary">Update Profile</button>
                </form>
            </div>
            <div id="user-management" class="tab-pane team-lead-only">
                <h2>User Management</h2>
                <button class="btn-primary" onclick="showUserForm()" style="margin-bottom: 25px;">Add User</button>
                <div id="users-list"></div>
            </div>
            <div id="assign-roles" class="tab-pane team-lead-only">
                <h2>Assign Roles</h2>
                <div id="roles-list"></div>
            </div>
        </div>
    </div>
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()" tabindex="0">√ó</span>
            <h2 id="modal-title"></h2>
            <div id="modal-body"></div>
        </div>
    </div>
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeLoginModal()" tabindex="0">√ó</span>
            <h2>Login</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-email" class="required">Email</label>
                    <input type="email" id="login-email" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="login-password" class="required">Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn-primary">Login</button>
            </form>
        </div>
    </div>
    <div id="email-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()" tabindex="0">√ó</span>
            <h2>Email Draft</h2>
            <form id="email-form">
                <div class="form-group">
                    <label for="email-to" class="required">To</label>
                    <input type="email" id="email-to" required>
                </div>
                <div class="form-group">
                    <label for="email-subject" class="required">Subject</label>
                    <input type="text" id="email-subject" required>
                </div>
                <div class="form-group">
                    <label for="email-body" class="required">Body</label>
                    <textarea id="email-body" required></textarea>
                </div>
                <button type="submit" class="btn-primary">Send Email</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAbCtk6PdlSE-XUiOHbg4HFF9rqqoT-Ymo",
            authDomain: "qa-team-dashboard-ff2e2.firebaseapp.com",
            projectId: "qa-team-dashboard-ff2e2",
            storageBucket: "qa-team-dashboard-ff2e2.firebasestorage.app",
            messagingSenderId: "604787545443",
            appId: "1:604787545443:web:c3829256d52ef5f5a1af56",
            measurementId: "G-7XZP4CP9X8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.auth = auth;
        window.db = db;
    </script>

    <script>
        let state = {
            currentUser: null,
            users: [],
            tasks: [],
            projects: [],
            projectOverview: [],
            approvedProjects: [],
            rejectedProjects: [],
            activityLog: [],
            standupEntries: [],
            testingPhases: [],
            projectTypes: [],
            sortDirection: {}
        };

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    state.currentUser = { id: user.uid, ...userDoc.data(), email: user.email };
                    showNotification(`Logged in as ${state.currentUser.name}`);
                    closeLoginModal();
                    updateUserAvatar();
                    setupSidebar();
                    switchTab('dashboard');
                    setupRealTimeListeners();
                } else {
                    showNotification('User profile not found. Please contact admin.', null, true);
                }
            } else {
                state.currentUser = null;
                showLoginModal();
                document.getElementById('user-name').textContent = '';
                document.getElementById('user-avatar').textContent = '';
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
            }
        });

        function showLoginModal() {
            document.getElementById('login-modal').style.display = 'flex';
            document.getElementById('login-email').focus();
        }

        function closeLoginModal() {
            document.getElementById('login-modal').style.display = 'none';
        }

        async function simulateLoginFromModal(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Login failed: ' + error.message, null, true);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            showLoginModal();
            document.getElementById('login-form').addEventListener('submit', simulateLoginFromModal);
            document.getElementById('standup-form').onsubmit = e => {
                e.preventDefault();
                submitStandup();
            };
            document.getElementById('profile-form').onsubmit = e => {
                e.preventDefault();
                updateProfile();
            };
        });

        function setupRealTimeListeners() {
            onSnapshot(collection(db, 'users'), (snapshot) => {
                state.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUsers();
            });

            onSnapshot(collection(db, 'tasks'), (snapshot) => {
                state.tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderKanban();
            });

            onSnapshot(collection(db, 'projects'), (snapshot) => {
                state.projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProjects();
            });

            onSnapshot(collection(db, 'projectOverview'), (snapshot) => {
                state.projectOverview = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProjectOverview();
            });

            onSnapshot(collection(db, 'approvedProjects'), (snapshot) => {
                state.approvedProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderApprovedProjects();
            });

            onSnapshot(collection(db, 'rejectedProjects'), (snapshot) => {
                state.rejectedProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRejectedProjects();
            });

            onSnapshot(query(collection(db, 'activityLog'), orderBy('timestamp', 'desc'), limit(50)), (snapshot) => {
                state.activityLog = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderActivityLog();
            });

            onSnapshot(collection(db, 'standupEntries'), (snapshot) => {
                state.standupEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStandup();
            });

            onSnapshot(collection(db, 'testingPhases'), (snapshot) => {
                state.testingPhases = snapshot.docs.map(doc => doc.data().name);
                renderProjectTypes();
            });

            onSnapshot(collection(db, 'projectTypes'), (snapshot) => {
                state.projectTypes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProjectTypes();
            });

            loadInitialData();
        }

        function setupSidebar() {
            const role = state.currentUser?.role || '';
            document.querySelectorAll('.sidebar-item').forEach(item => {
                const tabId = item.getAttribute('data-tab');
                if (role !== 'Admin') {
                    if (['project-management', 'project-types', 'qa-report', 'activity-log', 'user-management', 'assign-roles'].includes(tabId)) {
                        item.style.display = 'none';
                        return;
                    }
                }
                if (role === 'QA Member' && ['approved-projects', 'rejected-projects'].includes(tabId)) {
                    item.style.display = state.projectOverview.some(po => po.qaId === state.currentUser.id && po.approvedForLive === 'Yes') ? 'block' : 'none';
                } else {
                    item.style.display = 'block';
                }

                item.addEventListener('click', () => switchTab(tabId));
                item.setAttribute('tabindex', '0');
                item.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') switchTab(tabId);
                });
            });

            const adminControls = document.querySelector('.team-lead-admin');
            if (adminControls) adminControls.style.display = role === 'Admin' ? 'block' : 'none';
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
            const pane = document.getElementById(tabId);
            const item = document.querySelector(`.sidebar-item[data-tab="${tabId}"]`);
            if (pane && item && isAuthorized(tabId)) {
                pane.classList.add('active');
                item.classList.add('active');
                updateBreadcrumbs(tabId);
                loadTabData(tabId);
            }
        }

        function isAuthorized(tabId) {
            if (!state.currentUser) return false;
            const role = state.currentUser.role;
            if (role === 'Admin') return true;
            return !document.getElementById(tabId).classList.contains('team-lead-only') && !document.getElementById(tabId).classList.contains('team-lead-admin');
        }

        function updateBreadcrumbs(tabId) {
            const tabNames = {
                'dashboard': 'Dashboard',
                'daily-standup': 'Daily Standup',
                'kanban-board': 'Kanban Board',
                'project-management': 'Projects',
                'project-overview': 'Project Overview',
                'approved-projects': 'Approved Projects',
                'rejected-projects': 'Rejected Projects',
                'project-types': 'Project Types',
                'qa-report': 'QA Report',
                'activity-log': 'Activity Log',
                'profile': 'Profile',
                'user-management': 'User Management',
                'assign-roles': 'Assign Roles'
            };
            document.getElementById('breadcrumbs').innerHTML = `<a href="#" onclick="switchTab('dashboard')">Dashboard</a> > ${tabNames[tabId]}`;
        }

        function loadTabData(tabId) {
            showLoading();
            setTimeout(() => {
                const loaders = {
                    'dashboard': renderDashboard,
                    'daily-standup': renderStandup,
                    'kanban-board': renderKanban,
                    'project-management': renderProjects,
                    'project-overview': renderProjectOverview,
                    'approved-projects': renderApprovedProjects,
                    'rejected-projects': renderRejectedProjects,
                    'project-types': renderProjectTypes,
                    'qa-report': renderReports,
                    'activity-log': renderActivityLog,
                    'profile': renderProfile,
                    'user-management': renderUsers,
                    'assign-roles': renderAssignRoles
                };
                loaders[tabId]?.();
                hideLoading();
            }, 500);
        }

        function showNotification(message, userId = null, isError = false) {
            if (!userId || userId === state.currentUser?.id) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.classList.toggle('error-notification', isError);
                notification.style.display = 'block';
                setTimeout(() => notification.style.display = 'none', 3000);
            }
            if (state.currentUser) {
                addDoc(collection(db, 'activityLog'), {
                    action: `Notified: ${message}`,
                    user: state.currentUser.name,
                    timestamp: Date.now()
                });
            }
        }

        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal').style.display = 'flex';
            document.querySelector('.modal-close').focus();
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('email-modal').style.display = 'none';
        }

        function showLoading() {
            document.getElementById('loader').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loader').style.display = 'none';
        }

        function loadInitialData() {
            if (state.currentUser) {
                document.getElementById('user-name').textContent = `Welcome ${state.currentUser.name}`;
                document.getElementById('welcome-user').textContent = state.currentUser.name;
                const typeFilter = document.getElementById('report-filter-type');
                typeFilter.innerHTML = `<option value="">Filter by Type</option>` + state.projectTypes.flatMap(type => type.subcategories.map(sub => `<option value="${sub}">${sub}</option>`)).join('');
            }
        }

        function renderDashboardForAdmin() {
            const stats = calculateDashboardStats();
            const projectsByType = state.projectTypes.map(type => {
                const typeStats = stats[type.name] || { projects: 0, pendingApprovals: 0, completedProjects: 0 };
                return `
                    <div class="widget">
                        <h3>${type.name}</h3>
                        ${typeStats.projects === 0 ? `
                            <p>No projects yet‚Äîcreate one now!</p>
                        ` : `
                            <div class="stats">
                                <span class="stats-number">${typeStats.projects}</span>
                                <span>Projects</span>
                            </div>
                            <div class="stats-list">
                                <div class="stats-list-item">Pending Approvals: ${typeStats.pendingApprovals}</div>
                                <div class="stats-list-item">Completed Projects: ${typeStats.completedProjects}</div>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
            document.getElementById('dashboard-content').innerHTML = projectsByType;
        }

        function renderDashboardForMember() {
            const assignedProjects = state.projectOverview.filter(po => po.qaId === state.currentUser.id);
            const projectsSummary = assignedProjects.map(po => `
                <div class="widget">
                    <h3>${po.projectName}</h3>
                    <div class="stats-list">
                        <div class="stats-list-item">Type: ${po.projectType}</div>
                        <div class="stats-list-item">Phase: ${po.currentPhase}</div>
                        <div class="stats-list-item">Status: ${po.status}</div>
                        <div class="stats-list-item">Approved for Live: ${po.approvedForLive}</div>
                    </div>
                </div>
            `).join('');
            document.getElementById('dashboard-content').innerHTML = projectsSummary || `
                <div class="widget">
                    <h3>No Assigned Projects</h3>
                    <p>You currently have no projects assigned.</p>
                </div>
            `;
        }

        function renderDashboard() {
            if (!state.currentUser) return;
            if (state.currentUser.role === 'Admin') renderDashboardForAdmin();
            else renderDashboardForMember();
        }

        function renderStandup() {
            const tbody = document.querySelector('#standup-table tbody');
            tbody.innerHTML = '';
            const twoWeeksAgo = new Date();
            twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
            let filteredEntries = state.standupEntries;
            const searchDate = document.getElementById('standup-search-date')?.value;
            if (state.currentUser.role === 'Admin' && searchDate) {
                filteredEntries = filteredEntries.filter(entry => entry.date === new Date(searchDate).toLocaleDateString());
            } else {
                filteredEntries = filteredEntries.filter(entry => new Date(entry.date) >= twoWeeksAgo);
            }
            if (state.currentUser.role !== 'Admin') {
                filteredEntries = filteredEntries.filter(entry => entry.user === state.currentUser.name);
            }
            filteredEntries.forEach((entry, index) => {
                const row = document.createElement('tr');
                const isOwnEntry = entry.user === state.currentUser.name;
                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td>${entry.user}</td>
                    <td>${entry.yesterday}</td>
                    <td>${entry.today}</td>
                    <td>${entry.blockers || 'None'}</td>
                    <td>${isOwnEntry ? `
                        <button class="btn-primary" onclick="editStandup('${entry.id}')">Edit</button>
                        <button class="btn-danger" onclick="deleteStandup('${entry.id}')">Delete</button>
                    ` : '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        async function submitStandup() {
            const yesterday = document.getElementById('standup-yesterday').value.trim();
            const today = document.getElementById('standup-today').value.trim();
            if (!yesterday || !today) {
                showNotification('Please fill in all required fields', null, true);
                return;
            }
            const entry = {
                yesterday,
                today,
                blockers: document.getElementById('standup-blockers').value.trim(),
                user: state.currentUser.name,
                date: new Date().toLocaleDateString(),
                userId: state.currentUser.id
            };
            try {
                const docRef = await addDoc(collection(db, 'standupEntries'), entry);
                await addDoc(collection(db, 'activityLog'), {
                    action: 'Submitted standup',
                    user: state.currentUser.name,
                    timestamp: Date.now()
                });
                showNotification('Standup submitted successfully');
                document.getElementById('standup-form').reset();
            } catch (error) {
                console.error('Error submitting standup:', error);
                showNotification('Failed to submit standup', null, true);
            }
        }

        async function editStandup(id) {
            const entry = state.standupEntries.find(e => e.id === id);
            if (!entry) return;
            document.getElementById('standup-yesterday').value = entry.yesterday;
            document.getElementById('standup-today').value = entry.today;
            document.getElementById('standup-blockers').value = entry.blockers || '';
            try {
                await deleteDoc(doc(db, 'standupEntries', id));
                showNotification('Standup ready for edit');
            } catch (error) {
                console.error('Error editing standup:', error);
                showNotification('Failed to edit standup', null, true);
            }
        }

        async function deleteStandup(id) {
            try {
                await deleteDoc(doc(db, 'standupEntries', id));
                showNotification('Standup deleted successfully');
            } catch (error) {
                console.error('Error deleting standup:', error);
                showNotification('Failed to delete standup', null, true);
            }
        }

        function exportStandupData() {
            if (state.currentUser.role !== 'Admin') {
                showNotification('Only Admins can export standup data', null, true);
                return;
            }
            const fromDate = document.getElementById('standup-export-from').value;
            const toDate = document.getElementById('standup-export-to').value;
            if (!fromDate || !toDate) {
                showNotification('Please select both start and end dates', null, true);
                return;
            }
            const from = new Date(fromDate);
            const to = new Date(toDate);
            if (from > to) {
                showNotification('Start date must be before end date', null, true);
                return;
            }
            const filteredEntries = state.standupEntries.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= from && entryDate <= to;
            });
            const csv = [
                ['Date', 'User', 'Yesterday‚Äôs Work', 'Today‚Äôs Plan', 'Blockers'],
                ...filteredEntries.map(entry => [
                    entry.date,
                    entry.user,
                    `"${entry.yesterday.replace(/"/g, '""')}"`,
                    `"${entry.today.replace(/"/g, '""')}"`,
                    `"${(entry.blockers || 'None').replace(/"/g, '""')}"`
                ])
            ].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', `standup_report_${fromDate}_to_${toDate}.csv`);
            a.click();
            window.URL.revokeObjectURL(url);
            addDoc(collection(db, 'activityLog'), {
                action: `Exported standup data from ${fromDate} to ${toDate}`,
                user: state.currentUser.name,
                timestamp: Date.now()
            });
            showNotification('Standup data exported successfully');
        }

        function renderKanban() {
            const columns = ['to-do', 'in-progress', 'done'];
            columns.forEach(col => {
                const status = col.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
                let tasks = state.tasks.filter(t => t.status === status);
                if (!['Admin', 'Team Lead'].includes(state.currentUser.role)) {
                    tasks = tasks.filter(t => t.assignedTo === state.currentUser.id);
                }
                const taskHtml = tasks.length ? tasks.map(t => `
                    <div style="background: #34495e; padding: 14px; margin-bottom: 10px; border-radius: 4px; cursor: move; box-shadow: var(--shadow); color: var(--text-color); font-size: 16px;" draggable="true" ondragstart="drag(event, '${t.id}')">
                        ${t.name} (Assigned to: ${state.users.find(u => u.id === t.assignedTo)?.name || 'Unassigned'})
                    </div>
                `).join('') : `<p>No tasks yet‚Äîclick 'Add Task' to get started!</p>`;
                document.getElementById(`${col}-tasks`).innerHTML = taskHtml;
            });
        }

        function drag(event, taskId) {
            event.dataTransfer.setData('taskId', taskId);
        }

        function allowDrop(event) {
            event.preventDefault();
        }

        function dragEnter(event) {
            event.target.classList.add('dragover');
        }

        function dragLeave(event) {
            event.target.classList.remove('dragover');
        }

        async function drop(event, status) {
            event.preventDefault();
            event.target.classList.remove('dragover');
            const taskId = event.dataTransfer.getData('taskId');
            const task = state.tasks.find(t => t.id === taskId);
            if (task) {
                task.status = status;
                try {
                    await updateDoc(doc(db, 'tasks', taskId), { status });
                    await addDoc(collection(db, 'activityLog'), {
                        action: `Moved task "${task.name}" to ${status}`,
                        user: state.currentUser.name,
                        timestamp: Date.now()
                    });
                } catch (error) {
                    console.error('Error updating task status:', error);
                    showNotification('Failed to update task status', null, true);
                }
            }
        }

        function showTaskForm(taskId = null) {
            const task = taskId ? state.tasks.find(t => t.id === taskId) : null;
            const content = `
                <form id="task-form">
                    <div class="form-group">
                        <label for="task-name" class="required">Task Name</label>
                        <input type="text" id="task-name" value="${task ? task.name : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="task-project" class="required">Project</label>
                        <select id="task-project" required>
                            <option value="">Select Project</option>
                            ${state.projects.map(p => `<option value="${p.id}" ${task && task.projectId === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="task-phase" class="required">Phase</label>
                        <select id="task-phase" required>
                            <option value="">Select Phase</option>
                            ${state.testingPhases.map(phase => `<option value="${phase}" ${task && task.phase === phase ? 'selected' : ''}>${phase}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="task-assigned" class="required">Assigned To</label>
                        <select id="task-assigned" required>
                            <option value="">Select User</option>
                            ${state.users.map(u => `<option value="${u.id}" ${task && task.assignedTo === u.id ? 'selected' : ''}>${u.name}</option>`).join('')}
                        </select>
                    </div>
                    <button type="submit" class="btn-primary">${task ? 'Update' : 'Add'} Task</button>
                </form>
            `;
            showModal(`${task ? 'Edit' : 'Add'} Task`, content);
            document.getElementById('task-form').onsubmit = async (e) => {
                e.preventDefault();
                if (task) await updateTask(taskId);
                else await addTask();
            };
        }

        async function addTask() {
            const name = document.getElementById('task-name').value.trim();
            const projectId = document.getElementById('task-project').value;
            const phase = document.getElementById('task-phase').value;
            const assignedTo = document.getElementById('task-assigned').value;
            if (!name || !projectId || !phase || !assignedTo) {
                showNotification('All fields are required', null, true);
                return;
            }
            const task = { name, projectId, phase, assignedTo, status: 'To Do' };
            try {
                await addDoc(collection(db, 'tasks'), task);
                await addDoc(collection(db, 'activityLog'), {
                    action: `Added task: ${name}`,
                    user: state.currentUser.name,
                    timestamp: Date.now()
                });
                closeModal();
                showNotification('Task added successfully');
            } catch (error) {
                console.error('Error adding task:', error);
                showNotification('Failed to add task', null, true);
            }
        }

        async function updateTask(taskId) {
            const task = state.tasks.find(t => t.id === taskId);
            if (!task) return;
            task.name = document.getElementById('task-name').value.trim();
            task.projectId = document.getElementById('task-project').value;
            task.phase = document.getElementById('task-phase').value;
            task.assignedTo = document.getElementById('task-assigned').value;
            if (!task.name || !task.projectId || !task.phase || !task.assignedTo) {
                showNotification('All fields are required', null, true);
                return;
            }
            try {
                await updateDoc(doc(db, 'tasks', taskId), task);
                await addDoc(collection(db, 'activityLog'), {
                    action: `Updated task: ${task.name}`,
                    user: state.currentUser.name,
                    timestamp: Date.now()
                });
                closeModal();
                showNotification('Task updated successfully');
            } catch (error) {
                console.error('Error updating task:', error);
                showNotification('Failed to update task', null, true);
            }
        }

        function renderProjects() {
            document.getElementById('projects-list').innerHTML = state.projects.map(p => `
                <div class="list-item">
                    <span>${p.name} (${p.projectType}) - ${p.status}</span>
                    <div>
                        <button class="btn-primary" onclick="editProject('${p.id}')">Edit</button>
                        <button class="btn-danger" onclick="deleteProject('${p.id}')">Delete</button>
                    </div>
                </div>
            `).join('') || '<p>No projects yet‚Äîclick "Create Project" to start!</p>';
        }

        function showProjectForm(projectId = null) {
            const project = projectId ? state.projects.find(p => p.id === projectId) : null;
            const content = `
                <form id="project-form">
                    <div class="form-group">
                        <label for="project-name" class="required">Project Name</label>
                        <input type="text" id="project-name" value="${project ? project.name : ''}" placeholder="e.g., Website Redesign" required>
                    </div>
                    <div class="form-group">
                        <label for="project-type" class="required">Project Type</label>
                        <select id="project-type" required>
                            <option value="">Select Type</option>
                            ${state.projectTypes.flatMap(type => type.subcategories.map(sub => `
                                <option value="${sub}" ${project && project.projectType === sub ? 'selected' : ''}>${sub}</option>
                            `)).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bug-tracker-link">GitLab Link</label>
                        <input type="url" id="bug-tracker-link" value="${project ? project.bugTrackerLink : ''}" placeholder="e.g., https://gitlab.com/...">
                    </div>
                    <button type="submit" class="btn-primary">${project ? 'Update' : 'Create'} Project</button>
                </form>
            `;
            showModal(`${project ? 'Edit' : 'Create'} Project`, content);
            document.getElementById('project-form').onsubmit = async (e) => {
                e.preventDefault();
                if (project) await updateProject(projectId);
                else await createProject();
            };
        }

        async function createProject() {
            const name = document.getElementById('project-name').value.trim();
            const projectType = document.getElementById('project-type').value;
            const bugTrackerLink = document.getElementById('bug-tracker-link').value.trim();
            if (!name || !projectType) {
                showNotification('Project name and type are required', null, true);
                return;
            }
            const project = { name, projectType, bugTrackerLink, status: 'Not Started' };
            try {
                const docRef = await addDoc(collection(db, 'projects'), project);
                await addDoc(collection(db, 'projectOverview'), {
                    projectId: docRef.id,
                    projectName: name,
                    qaId: null,
                    projectType,
                    currentPhase: state.testingPhases[0] || 'Not Started',
                    ktReceived: 'No',
                    startDate: new Date().toISOString().split('T')[0],
                    endDate: '',
                    status: 'Not Started',
                    approvedForLive: 'No',
                    approvedDate: '',
                    rejectionDate: '',
                    rejectionReason: '',
                    rejectedBy: '',
                    tlApproval: 'Pending'
                });
                await addDoc(collection(db, 'activityLog'), {
                    action: `Created project: ${name}`,
                    user: state.currentUser.name,
                    timestamp: Date.now()
                });
                closeModal();
                showNotification('Project created successfully');
            } catch (error) {
                console.error('Error creating project:', error);
                showNotification('Failed to create project', null, true);
            }
        }

        async function updateProject(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            const name = document.getElementById('project-name').value.trim();
            const projectType = document.getElementById('project-type').value;
            const bugTrackerLink = document.getElementById('bug-tracker-link').value.trim();
            if (!name || !projectType) {
                showNotification('Project name and type are required', null, true);
                return;
            }
            project.name = name;
            project.projectType = projectType;
            project.bugTrackerLink = bugTrackerLink;
            try {
                await updateDoc(doc(db, 'projects', projectId), project);
                const poDoc = state.projectOverview.find(po => po.projectId === projectId);
                if (poDoc) {
                    await updateDoc(doc(db, 'projectOverview', poDoc.id), {
                        projectName: name,
                        projectType
                    });
                }
                await addDoc(collection(db, 'activityLog'), {
                    action: `Updated project: ${name}`,
                    user: state.currentUser.name,
                    timestamp: Date.now()
                });
                closeModal();
                showNotification('Project updated successfully');
            } catch (error) {
                console.error('Error updating project:', error);
                showNotification('Failed to update project', null, true);
            }
        }

        function editProject(projectId) {
            showProjectForm(projectId);
        }

        async function deleteProject(projectId) {
            try {
                await deleteDoc(doc(db, 'projects', projectId));
                const poDoc = state.projectOverview.find(po => po.projectId === projectId);
                if (poDoc) await deleteDoc(doc(db, 'projectOverview', poDoc.id));
                await addDoc(collection(db, 'activityLog'), {
                    action: `Deleted project: ${state.projects.find(p => p.id === projectId)?.name}`,
                    user: state.currentUser.name,
                    timestamp: Date.now()
                });
                showNotification('Project deleted successfully');
            } catch (error) {
                console.error('Error deleting project:', error);
                showNotification('Failed to delete project', null, true);
            }
        }

        function renderProjectOverview() {
            const tbody = document.getElementById('project-overview-table');
            tbody.innerHTML = '';
            let filteredProjects = state.projectOverview;
            if (state.currentUser.role !== 'Admin') {
                filteredProjects = filteredProjects.filter(po => po.qaId === state.currentUser.id);
            }
            filteredProjects.forEach(po => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${po.projectName}</td>
                    <td>${state.users.find(u => u.id === po.qaId)?.name || 'Unassigned'}</td>
                    <td>${po.projectType}</td>
                    <td>
                        <select onchange="updatePhase('${po.id}', this.value)">
                            ${state.testingPhases.map(phase => `<option value="${phase}" ${po.currentPhase === phase ? 'selected' : ''}>${phase}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <select onchange="updateKT('${po.id}', this.value)">
                            <option value="Yes" ${po.ktReceived === 'Yes' ? 'selected' : ''}>Yes</option>
                            <option value="No" ${po.ktReceived === 'No' ? 'selected' : ''}>No</option>
                        </select>
                    </td>
                    <td>${po.startDate}</td>
                    <td>${po.endDate || 'N/A'}</td>
                    <td>${po.status}</td>
                    <td>${po.tlApproval === 'Pending' ? `
                        <button class="btn-primary" onclick="submitForTLApproval('${po.id}')">Submit for TL Approval</button>
                    ` : po.tlApproval}</td>
                    <td>${po.tlApproval === 'Approved' && state.currentUser.role === 'Admin' ? `
                        <select onchange="updateApproval('${po.id}', this.value)">
                            <option value="Yes" ${po.approvedForLive === 'Yes' ? 'selected' : ''}>Yes</option>
                            <option value="No" ${po.approvedForLive === 'No' ? 'selected' : ''}>No</option>
                            <option value="Rejected" ${po.approvedForLive === 'Rejected' ? 'selected' : ''}>Reject</option>
                        </select>
                    ` : po.tlApproval === 'Approved' ? po.approvedForLive : 'N/A'}</td>
                    <td>${po.tlApproval === 'Approved' && state.currentUser.role === 'Admin' ? `
                        <button class="btn-primary" onclick="sendEmail('${po.projectId}')">Send Email</button>
                    ` : ''}</td>
                `;
                tbody.appendChild(row);
            });
        }

        async function updatePhase(projectOverviewId, phase) {
            const projectEntry = state.projectOverview.find(po => po.id === projectOverviewId);
            if (projectEntry) {
                try {
                    await updateDoc(doc(db, 'projectOverview', projectOverviewId), { currentPhase: phase });
                    await addDoc(collection(db, 'activityLog'), {
                        action: `Updated phase to ${phase} for ${projectEntry.projectName}`,
                        user: state.currentUser.name,
                        timestamp: Date.now()
                    });
                } catch (error) {
                    console.error('Error updating phase:', error);
                    showNotification('Failed to update phase', null, true);
                }
            }
        }

        async function updateKT(projectOverviewId, ktReceived) {
            const projectEntry = state.projectOverview.find(po => po.id === projectOverviewId);
            if (projectEntry) {
                try {
                    await updateDoc(doc(db, 'projectOverview', projectOverviewId), { ktReceived });
                    await addDoc(collection(db, 'activityLog'), {
                        action: `Updated KT to ${ktReceived} for ${projectEntry.projectName}`,
                        user: state.currentUser.name,
                        timestamp: Date.now()
                    });
                } catch (error) {
                    console.error('Error updating KT:', error);
                    showNotification('Failed to update KT', null, true);
                }
            }
        }

        async function submitForTLApproval(projectOverviewId) {
            const projectEntry = state.projectOverview.find(po => po.id === projectOverviewId);
            if (projectEntry) {
                try {
                    await updateDoc(doc(db, 'projectOverview', projectOverviewId), { tlApproval: 'Approved' });
                    await addDoc(collection(db, 'activityLog'), {
                        action: `Submitted ${projectEntry.projectName} for TL approval`,
                        user: state.currentUser.name,
                        timestamp: Date.now()
                    });
                    showNotification('Project submitted for TL approval');
                } catch (error) {
                    console.error('Error submitting for TL approval:', error);
                    showNotification('Failed to submit for TL approval', null, true);
                }
            }
        }

        async function updateApproval(projectOverviewId, approval) {
            const projectEntry = state.projectOverview.find(po => po.id === projectOverviewId);
            if (!projectEntry) return;
            const currentDate = new Date().toISOString().split('T')[0];
            try {
                if (approval === 'Yes') {
                    await updateDoc(doc(db, 'projectOverview', projectOverviewId), {
                        approvedForLive: 'Yes',
                        approvedDate: currentDate,
                        status: 'Completed',
                        endDate: currentDate
                    });
                    const approvedDoc = await addDoc(collection(db, 'approvedProjects'), { ...projectEntry, approvedForLive: 'Yes', approvedDate: currentDate });
                    await deleteDoc(doc(db, 'projectOverview', projectOverviewId));
                    await addDoc(collection(db, 'activityLog'), {
                        action: `Approved ${projectEntry.projectName} for live`,
                        user: state.currentUser.name,
                        timestamp: Date.now()
                    });
                    showNotification('Project approved for live');
                } else if (approval === 'Rejected') {
                    const reason = prompt('Enter rejection reason:');
                    if (reason) {
                        await updateDoc(doc(db, 'projectOverview', projectOverviewId), {
                            approvedForLive: 'Rejected',
                            rejectionDate: currentDate,
                            rejectionReason: reason,
                            rejectedBy: state.currentUser.name
                        });
                        const rejectedDoc = await addDoc(collection(db, 'rejectedProjects'), {
                            ...projectEntry,
                            approvedForLive: 'Rejected',
                            rejectionDate: currentDate,
                            rejectionReason: reason,
                            rejectedBy: state.currentUser.name
                        });
                        await deleteDoc(doc(db, 'projectOverview', projectOverviewId));
                        await addDoc(collection(db, 'activityLog'), {
                            action: `Rejected ${projectEntry.projectName} with reason: ${reason}`,
                            user: state.currentUser.name,
                            timestamp: Date.now()
                        });
                        showNotification('Project rejected');
                    } else {
                        showNotification('Rejection reason is required', null, true);
                    }
                } else {
                    await updateDoc(doc(db, 'projectOverview', projectOverviewId), { approvedForLive: 'No' });
                }
            } catch (error) {
                console.error('Error updating approval:', error);
                showNotification('Failed to update approval', null, true);
            }
        }

        function renderApprovedProjects() {
            const tbody = document.getElementById('approved-projects-table');
            tbody.innerHTML = '';
            let filteredProjects = state.approvedProjects;
            if (state.currentUser.role !== 'Admin') {
                filteredProjects = filteredProjects.filter(ap => ap.qaId === state.currentUser.id);
            }
            filteredProjects.forEach(ap => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${ap.projectName}</td>
                    <td>${state.users.find(u => u.id === ap.qaId)?.name || 'Unassigned'}</td>
                    <td>${ap.projectType}</td>
                    <td>${ap.currentPhase}</td>
                    <td>${ap.ktReceived}</td>
                    <td>${ap.startDate}</td>
                    <td>${ap.endDate || 'N/A'}</td>
                    <td>${ap.status}</td>
                    <td>${ap.approvedDate}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderRejectedProjects() {
            const tbody = document.getElementById('rejected-projects-table');
            tbody.innerHTML = '';
            let filteredProjects = state.rejectedProjects;
            if (state.currentUser.role !== 'Admin') {
                filteredProjects = filteredProjects.filter(rp => rp.qaId === state.currentUser.id);
            }
            filteredProjects.forEach(rp => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${rp.projectName}</td>
                    <td>${state.users.find(u => u.id === rp.qaId)?.name || 'Unassigned'}</td>
                    <td>${rp.projectType}</td>
                    <td>${rp.currentPhase}</td>
                    <td>${rp.ktReceived}</td>
                    <td>${rp.startDate}</td>
                    <td>${rp.endDate || 'N/A'}</td>
                    <td>${rp.status}</td>
                    <td>${rp.rejectionDate}</td>
                    <td>${rp.rejectionReason}</td>
                    <td>${rp.rejectedBy}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function sendEmail(projectId) {
            const projectEntry = state.projects.find(p => p.id === projectId);
            if (!projectEntry) return;
            const projectOverview = state.projectOverview.find(po => po.projectId === projectId);
            const qaName = state.users.find(u => u.id === projectOverview?.qaId)?.name || 'Unassigned';
            const content = `
                <form id="email-form">
                    <div class="form-group">
                        <label for="email-to" class="required">To</label>
                        <input type="email" id="email-to" value="" required>
                    </div>
                    <div class="form-group">
                        <label for="email-subject" class="required">Subject</label>
                        <input type="text" id="email-subject" value="Project ${projectEntry.name} Approved for Live" required>
                    </div>
                    <div class="form-group">
                        <label for="email-body" class="required">Body</label>
                        <textarea id="email-body" required>Hello,\n\nThe project "${projectEntry.name}" (Type: ${projectEntry.projectType}) has been approved for live deployment.\n\nQA: ${qaName}\nPhase: ${projectOverview?.currentPhase}\nApproval Date: ${new Date().toLocaleDateString()}\n\nRegards,\n${state.currentUser.name}</textarea>
                    </div>
                    <button type="submit" class="btn-primary">Send Email</button>
                </form>
            `;
            document.getElementById('email-modal').style.display = 'flex';
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('email-form').onsubmit = async (e) => {
                e.preventDefault();
                const to = document.getElementById('email-to').value.trim();
                const subject = document.getElementById('email-subject').value.trim();
                const body = document.getElementById('email-body').value.trim();
                if (!to || !subject || !body) {
                    showNotification('All fields are required', null, true);
                    return;
                }
                try {
                    await addDoc(collection(db, 'activityLog'), {
                        action: `Sent email for project: ${projectEntry.name}`,
                        user: state.currentUser.name,
                        timestamp: Date.now()
                    });
                    showNotification('Email draft prepared (Note: Actual email sending requires backend integration)');
                    closeModal();
                    window.location.href = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                } catch (error) {
                    console.error('Error preparing email:', error);
                    showNotification('Failed to prepare email', null, true);
                }
            };
        }

        function renderProjectTypes() {
            const categoriesList = document.getElementById('project-types-list');
            categoriesList.innerHTML = state.projectTypes.map(type => `
                <div class="category-item">
                    <span>${type.name}</span>
                    <div>
                        <button class="btn-primary" onclick="editCategory('${type.id}')">Edit</button>
                        <button class="btn-danger" onclick="deleteCategory('${type.id}')">Delete</button>
                    </div>
                </div>
                <div class="subcategory-list">
                    ${type.subcategories.map(sub => `
                        <div class="subcategory-item">
                            <span>${sub}</span>
                            <button class="btn-danger" onclick="deleteSubcategory('${type.id}', '${sub}')">Delete</button>
                        </div>
                    `).join('')}
                </div>
            `).join('') || '<p>No categories yet‚Äîclick "Add Category" to start!</p>';

            const phasesList = document.getElementById('testing-phases-list');
            phasesList.innerHTML = state.testingPhases.map(phase => `
                <div class="list-item">
                    <span>${phase}</span>
                    <button class="btn-danger" onclick="deletePhase('${phase}')">Delete</button>
                </div>
            `).join('') || '<p>No testing phases yet‚Äîclick "Add Testing Phase" to start!</p>';
        }

        function showCategoryForm(categoryId = null) {
            const category = categoryId ? state.projectTypes.find(t => t.id === categoryId) : null;
            const content = `
                <form id="category-form">
                    <div class="form-group">
                        <label for="category-name" class="required">Category Name</label>
                        <input type="text" id="category-name" value="${category ? category.name : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="subcategory-name">Subcategory (optional, comma-separated)</label>
                        <input type="text" id="subcategory-name" value="${category ? category.subcategories.join(', ') : ''}" placeholder="e.g., Web, Mobile">
                    </div>
                    <button type="submit" class="btn-primary">${category ? 'Update' : 'Add'} Category</button>
                </form>
            `;
            showModal(`${category ? 'Edit' : 'Add'} Category`, content);
            document.getElementById('category-form').onsubmit = async (e) => {
                e.preventDefault();
                if (category) await updateCategory(categoryId);
                else await addCategory();
            };
        }

        async function addCategory() {
            const name = document.getElementById('category-name').value.trim();
            const subcategoriesInput = document.getElementById('subcategory-name').value.trim();
            const subcategories = subcategoriesInput ? subcategoriesInput.split(',').map(s => s.trim()).filter(s => s) : [];
            if (!name) {
                showNotification('Category name is required', null, true);
                return;
            }
            try {
                await addDoc(collection(db, 'projectTypes'), { name, subcategories });
                await addDoc(collection(db, 'activityLog'), {
                    action: `Added category: ${name}`,
                    user: state.currentUser.name,
                    timestamp: Date.now()
                });
                closeModal();
                showNotification('Category added successfully');
            } catch (error) {
                console.error('Error adding category:', error);
                showNotification('Failed to add category', null, true);
            }
        }

        async function updateCategory(categoryId) {
            const category = state.projectTypes.find(t => t.id === categoryId);
            if (!category) return;
            category.name = document.getElementById('category-name').value.trim();
            const subcategoriesInput = document.getElementById('subcategory-name').value.trim();
            category.subcategories = subcategoriesInput ? subcategoriesInput.split(',').map(s => s.trim()).filter(s => s) : [];
            if (!category.name) {
                showNotification('Category name is required', null, true);
                return;
            }
            try {
                await updateDoc(doc(db, 'projectTypes', categoryId), category);
                await addDoc(collection(db, 'activityLog'), {
                    action: `Updated category: ${category.name}`,
                    user: state.currentUser.name,
                    timestamp: Date.now()
                });
                closeModal();
                showNotification('Category updated successfully');
            } catch (error) {
                console.error('Error updating category:', error);
                showNotification('Failed to update category', null, true);
            }
        }

        function editCategory(categoryId) {
            showCategoryForm(categoryId);
        }

        async function deleteCategory(categoryId) {
            try {
                const category = state.projectTypes.find(t => t.id === categoryId);
                await deleteDoc(doc(db, 'projectTypes', categoryId));
                await addDoc(collection(db, 'activityLog'), {
                    action: `Deleted category: ${category.name}`,
                    user: state.currentUser.name,
                    timestamp: Date.now()
                });
                showNotification('Category deleted successfully');
            } catch (error) {
                console.error('Error deleting category:', error);
                showNotification('Failed to delete category', null, true);
            }
        }

        async function deleteSubcategory(categoryId, subcategory) {
            const category = state.projectTypes.find(t => t.id === categoryId);
            if (!category) return;
            category.subcategories = category.subcategories.filter(s => s !== subcategory);
            try {
                await updateDoc(doc(db, 'projectTypes', categoryId), { subcategories: category.subcategories });
                await addDoc(collection(db, 'activityLog'), {
                    action: `Deleted subcategory "${subcategory}" from ${category.name}`,
                    user: state.currentUser.name,
                    timestamp: Date.now()
                });
                showNotification('Subcategory deleted successfully');
            } catch (error) {
                console.error('Error deleting subcategory:', error);
                showNotification('Failed to delete subcategory', null, true);
            }
        }

        function showPhaseForm() {
            const content = `
                <form id="phase-form">
                    <div class="form-group">
                        <label for="phase-name" class="required">Testing Phase Name</label>
                        <input type="text" id="phase-name" required>
                    </div>
                    <button type="submit" class="btn-primary">Add Phase</button>
                </form>
            `;
            showModal('Add Testing Phase', content);
            document.getElementById('phase-form').onsubmit = async (e) => {
                e.preventDefault();
                await addPhase();
            };
        }

        async function addPhase() {
            const name = document.getElementById('phase-name').value.trim();
            if (!name) {
                showNotification('Phase name is required', null, true);
                return;
            }
            if (state.testingPhases.includes(name)) {
                showNotification('This phase already exists', null, true);
                return;
            }
            try {
                await addDoc(collection(db, 'testingPhases'), { name });
                await addDoc(collection(db, 'activityLog'), {
                    action: `Added testing phase: ${name}`,
                    user: state.currentUser.name,
                    timestamp: Date.now()
                });
                closeModal();
                showNotification('Testing phase added successfully');
            } catch (error) {
                console.error('Error adding phase:', error);
                showNotification('Failed to add phase', null, true);
            }
        }

        async function deletePhase(phase) {
            try {
                const phaseDoc = (await getDocs(query(collection(db, 'testingPhases'), where('name', '==', phase)))).docs[0];
                await deleteDoc(doc(db, 'testingPhases', phaseDoc.id));
                await addDoc(collection(db, 'activityLog'), {
                    action: `Deleted testing phase: ${phase}`,
                    user: state.currentUser.name,
                    timestamp: Date.now()
                });
                showNotification('Testing phase deleted successfully');
            } catch (error) {
                console.error('Error deleting phase:', error);
                showNotification('Failed to delete phase', null, true);
            }
        }

        function renderReports() {
            const tbody = document.querySelector('#reports-list tbody');
            tbody.innerHTML = '';
            const dateFilter = document.getElementById('report-filter-date').value;
            const qaFilter = document.getElementById('report-filter-qa').value;
            const projectFilter = document.getElementById('report-filter-project').value;
            const typeFilter = document.getElementById('report-filter-type').value;
            let filteredProjects = state.projectOverview;
            if (dateFilter) filteredProjects = filteredProjects.filter(p => p.startDate === dateFilter);
            if (qaFilter) filteredProjects = filteredProjects.filter(p => p.qaId === qaFilter);
            if (projectFilter) filteredProjects = filteredProjects.filter(p => p.projectId === projectFilter);
            if (typeFilter) filteredProjects = filteredProjects.filter(p => p.projectType === typeFilter);
            filteredProjects.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${p.projectName}</td>
                    <td>${state.users.find(u => u.id === p.qaId)?.name || 'Unassigned'}</td>
                    <td>${p.projectType}</td>
                    <td>${p.currentPhase}</td>
                    <td>${p.status}</td>
                    <td>${p.approvedForLive}</td>
                `;
                tbody.appendChild(row);
            });
            const qaSelect = document.getElementById('report-filter-qa');
            qaSelect.innerHTML = `<option value="">Filter by QA</option>` + state.users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
            const projectSelect = document.getElementById('report-filter-project');
            projectSelect.innerHTML = `<option value="">Filter by Project</option>` + state.projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }

        function exportReport() {
            const dateFilter = document.getElementById('report-filter-date').value;
            const qaFilter = document.getElementById('report-filter-qa').value;
            const projectFilter = document.getElementById('report-filter-project').value;
            const typeFilter = document.getElementById('report-filter-type').value;
            let filteredProjects = state.projectOverview;
            if (dateFilter) filteredProjects = filteredProjects.filter(p => p.startDate === dateFilter);
            if (qaFilter) filteredProjects = filteredProjects.filter(p => p.qaId === qaFilter);
            if (projectFilter) filteredProjects = filteredProjects.filter(p => p.projectId === projectFilter);
            if (typeFilter) filteredProjects = filteredProjects.filter(p => p.projectType === typeFilter);
            const csv = [
                ['Project Name', 'QA', 'Type', 'Phase', 'Status', 'Approved?'],
                ...filteredProjects.map(p => [
                    p.projectName,
                    state.users.find(u => u.id === p.qaId)?.name || 'Unassigned',
                    p.projectType,
                    p.currentPhase,
                    p.status,
                    p.approvedForLive
                ])
            ].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', `qa_report_${new Date().toISOString().split('T')[0]}.csv`);
            a.click();
            window.URL.revokeObjectURL(url);
            addDoc(collection(db, 'activityLog'), {
                action: 'Exported QA report',
                user: state.currentUser.name,
                timestamp: Date.now()
            });
            showNotification('QA report exported successfully');
        }

        function renderActivityLog() {
            document.getElementById('activity-log-list').innerHTML = state.activityLog.map(log => `
                <div class="list-item">
                    <span>${new Date(log.timestamp).toLocaleString()} - ${log.user}: ${log.action}</span>
                </div>
            `).join('') || '<p>No activity yet.</p>';
        }

        function renderProfile() {
            document.getElementById('profile-name').value = state.currentUser.name;
            document.getElementById('profile-email').value = state.currentUser.email;
            document.getElementById('profile-password').value = '';
        }

        async function updateProfile() {
            const name = document.getElementById('profile-name').value.trim();
            const email = document.getElementById('profile-email').value.trim();
            const password = document.getElementById('profile-password').value;
            if (!name || !email) {
                showNotification('Name and email are required', null, true);
                return;
            }
            try {
                const userDoc = doc(db, 'users', state.currentUser.id);
                await updateDoc(userDoc, { name, email });
                if (password) {
                    await auth.currentUser.updatePassword(password);
                }
                state.currentUser.name = name;
                state.currentUser.email = email;
                updateUserAvatar();
                await addDoc(collection(db, 'activityLog'), {
                    action: 'Updated profile',
                    user: state.currentUser.name,
                    timestamp: Date.now()
                });
                showNotification('Profile updated successfully');
            } catch (error) {
                console.error('Error updating profile:', error);
                showNotification('Failed to update profile', null, true);
            }
        }

        function renderUsers() {
            document.getElementById('users-list').innerHTML = state.users.map(u => `
                <div class="list-item">
                    <span>${u.name} (${u.email}) - ${u.role}</span>
                    <div>
                        <button class="btn-primary" onclick="editUser('${u.id}')">Edit</button>
                        <button class="btn-danger" onclick="deleteUser('${u.id}')">Delete</button>
                    </div>
                </div>
            `).join('') || '<p>No users yet‚Äîclick "Add User" to start!</p>';
        }

        function showUserForm(userId = null) {
            const user = userId ? state.users.find(u => u.id === userId) : null;
            const content = `
                <form id="user-form">
                    <div class="form-group">
                        <label for="user-name" class="required">Name</label>
                        <input type="text" id="user-name" value="${user ? user.name : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="user-email" class="required">Email</label>
                        <input type="email" id="user-email" value="${user ? user.email : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="user-password" class="${user ? '' : 'required'}">Password</label>
                        <input type="password" id="user-password" ${user ? '' : 'required'} placeholder="${user ? 'Leave blank to keep current' : ''}">
                    </div>
                    <div class="form-group">
                        <label for="user-role" class="required">Role</label>
                        <select id="user-role" required>
                            <option value="Admin" ${user && user.role === 'Admin' ? 'selected' : ''}>Admin</option>
                            <option value="Team Lead" ${user && user.role === 'Team Lead' ? 'selected' : ''}>Team Lead</option>
                            <option value="QA Member" ${user && user.role === 'QA Member' ? 'selected' : ''}>QA Member</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary">${user ? 'Update' : 'Add'} User</button>
                </form>
            `;
            showModal(`${user ? 'Edit' : 'Add'} User`, content);
            document.getElementById('user-form').onsubmit = async (e) => {
                e.preventDefault();
                if (user) await updateUser(userId);
                else await addUser();
            };
        }

        async function addUser() {
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const password = document.getElementById('user-password').value;
            const role = document.getElementById('user-role').value;
            if (!name || !email || !password || !role) {
                showNotification('All fields are required', null, true);
                return;
            }
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const userId = userCredential.user.uid;
                await addDoc(collection(db, 'users'), { id: userId, name, email, role });
                await addDoc(collection(db, 'activityLog'), {
                    action: `Added user: ${name}`,
                    user: state.currentUser.name,
                    timestamp: Date.now()
                });
                closeModal();
                showNotification('User added successfully');
            } catch (error) {
                console.error('Error adding user:', error);
                showNotification('Failed to add user: ' + error.message, null, true);
            }
        }

        async function updateUser(userId) {
            const user = state.users.find(u => u.id === userId);
            if (!user) return;
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const password = document.getElementById('user-password').value;
            const role = document.getElementById('user-role').value;
            if (!name || !email || !role) {
                showNotification('Name, email, and role are required', null, true);
                return;
            }
            try {
                await updateDoc(doc(db, 'users', userId), { name, email, role });
                if (password) {
                    const userCredential = await signInWithEmailAndPassword(auth, user.email, prompt('Enter current password to update:'));
                    await userCredential.user.updatePassword(password);
                }
                await addDoc(collection(db, 'activityLog'), {
                    action: `Updated user: ${name}`,
                    user: state.currentUser.name,
                    timestamp: Date.now()
                });
                closeModal();
                showNotification('User updated successfully');
            } catch (error) {
                console.error('Error updating user:', error);
                showNotification('Failed to update user', null, true);
            }
        }

        function editUser(userId) {
            showUserForm(userId);
        }

        async function deleteUser(userId) {
            try {
                await deleteDoc(doc(db, 'users', userId));
                await addDoc(collection(db, 'activityLog'), {
                    action: `Deleted user: ${state.users.find(u => u.id === userId)?.name}`,
                    user: state.currentUser.name,
                    timestamp: Date.now()
                });
                showNotification('User deleted successfully');
            } catch (error) {
                console.error('Error deleting user:', error);
                showNotification('Failed to delete user', null, true);
            }
        }

        function renderAssignRoles() {
            document.getElementById('roles-list').innerHTML = state.projectOverview.map(po => `
                <div class="list-item">
                    <span>${po.projectName} - Assigned QA: ${state.users.find(u => u.id === po.qaId)?.name || 'Unassigned'}</span>
                    <select onchange="assignQA('${po.id}', this.value)">
                        <option value="">Unassign</option>
                        ${state.users.filter(u => u.role === 'QA Member').map(u => `
                            <option value="${u.id}" ${po.qaId === u.id ? 'selected' : ''}>${u.name}</option>
                        `).join('')}
                    </select>
                </div>
            `).join('') || '<p>No projects available for role assignment.</p>';
        }

        async function assignQA(projectOverviewId, qaId) {
            const projectEntry = state.projectOverview.find(po => po.id === projectOverviewId);
            if (!projectEntry) return;
            try {
                await updateDoc(doc(db, 'projectOverview', projectOverviewId), { qaId: qaId || null });
                await addDoc(collection(db, 'activityLog'), {
                    action: `Assigned QA ${state.users.find(u => u.id === qaId)?.name || 'Unassigned'} to ${projectEntry.projectName}`,
                    user: state.currentUser.name,
                    timestamp: Date.now()
                });
                showNotification('QA assigned successfully');
            } catch (error) {
                console.error('Error assigning QA:', error);
                showNotification('Failed to assign QA', null, true);
            }
        }

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('collapsed');
        }

        function updateUserAvatar() {
            const avatar = document.getElementById('user-avatar');
            const name = state.currentUser?.name || '';
            avatar.textContent = name.split(' ').map(w => w[0]).join('').toUpperCase();
            document.getElementById('user-name').textContent = name;
        }

        async function logout() {
            try {
                await signOut(auth);
                showNotification('Logged out successfully');
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Failed to log out', null, true);
            }
        }

        function filterProjects() {
            const search = document.getElementById('project-search').value.toLowerCase();
            const tbody = document.getElementById('project-overview-table');
            tbody.innerHTML = '';
            let filteredProjects = state.projectOverview;
            if (state.currentUser.role !== 'Admin') {
                filteredProjects = filteredProjects.filter(po => po.qaId === state.currentUser.id);
            }
            filteredProjects = filteredProjects.filter(po =>
                po.projectName.toLowerCase().includes(search) ||
                po.projectType.toLowerCase().includes(search) ||
                po.status.toLowerCase().includes(search)
            );
            filteredProjects.forEach(po => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${po.projectName}</td>
                    <td>${state.users.find(u => u.id === po.qaId)?.name || 'Unassigned'}</td>
                    <td>${po.projectType}</td>
                    <td>
                        <select onchange="updatePhase('${po.id}', this.value)">
                            ${state.testingPhases.map(phase => `<option value="${phase}" ${po.currentPhase === phase ? 'selected' : ''}>${phase}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <select onchange="updateKT('${po.id}', this.value)">
                            <option value="Yes" ${po.ktReceived === 'Yes' ? 'selected' : ''}>Yes</option>
                            <option value="No" ${po.ktReceived === 'No' ? 'selected' : ''}>No</option>
                        </select>
                    </td>
                    <td>${po.startDate}</td>
                    <td>${po.endDate || 'N/A'}</td>
                    <td>${po.status}</td>
                    <td>${po.tlApproval === 'Pending' ? `
                        <button class="btn-primary" onclick="submitForTLApproval('${po.id}')">Submit for TL Approval</button>
                    ` : po.tlApproval}</td>
                    <td>${po.tlApproval === 'Approved' && state.currentUser.role === 'Admin' ? `
                        <select onchange="updateApproval('${po.id}', this.value)">
                            <option value="Yes" ${po.approvedForLive === 'Yes' ? 'selected' : ''}>Yes</option>
                            <option value="No" ${po.approvedForLive === 'No' ? 'selected' : ''}>No</option>
                            <option value="Rejected" ${po.approvedForLive === 'Rejected' ? 'selected' : ''}>Reject</option>
                        </select>
                    ` : po.tlApproval === 'Approved' ? po.approvedForLive : 'N/A'}</td>
                    <td>${po.tlApproval === 'Approved' && state.currentUser.role === 'Admin' ? `
                        <button class="btn-primary" onclick="sendEmail('${po.projectId}')">Send Email</button>
                    ` : ''}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function sortTable(columnIndex) {
            const table = document.querySelector('#project-overview-table').closest('table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const isAscending = !state.sortDirection[columnIndex];
            state.sortDirection[columnIndex] = isAscending;
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].textContent.trim();
                const bValue = b.cells[columnIndex].textContent.trim();
                return isAscendin
g ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
            });
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
            table.querySelectorAll('th').forEach((th, i) => {
                th.textContent = th.textContent.replace(/[‚Üë‚Üì]/g, '');
                if (i === columnIndex) th.textContent += isAscending ? '‚Üë' : '‚Üì';
            });
        }

        function calculateDashboardStats() {
            const stats = {};
            state.projectTypes.forEach(type => {
                stats[type.name] = {
                    projects: 0,
                    pendingApprovals: 0,
                    completedProjects: 0
                };
            });
            state.projectOverview.forEach(po => {
                const type = state.projectTypes.find(t => t.subcategories.includes(po.projectType))?.name;
                if (type && stats[type]) {
                    stats[type].projects++;
                    if (po.tlApproval === 'Pending') stats[type].pendingApprovals++;
                    if (po.approvedForLive === 'Yes') stats[type].completedProjects++;
                }
            });
            return stats;
        }
    </script>
</body>
</html>
