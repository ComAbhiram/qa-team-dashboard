<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA Team Dashboard</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-color: #1a2526;
            --widget-background: #2e3f52;
            --text-color: #f5f5f5;
            --shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            --border-radius: 6px;
            --light-background: #f5f5f5;
            --light-widget: #ffffff;
            --light-text: #333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .light-theme {
            --background-color: var(--light-background);
            --widget-background: var(--light-widget);
            --text-color: var(--light-text);
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background-color: var(--widget-background);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: width 0.3s;
            position: relative;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar.collapsed .sidebar-item span {
            display: none;
        }

        .sidebar.collapsed .sidebar-item {
            justify-content: center;
        }

        .sidebar-item {
            padding: 14px 18px;
            margin-bottom: 10px;
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: background-color 0.3s;
            color: var(--text-color);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-item:hover,
        .sidebar-item.active {
            background-color: var(--primary-color);
            color: #fff;
        }

        .sidebar-toggle {
            font-size: 20px;
            cursor: pointer;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .main-content {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
        }

        .breadcrumbs {
            margin-bottom: 15px;
            font-size: 12px;
            color: var(--secondary-color);
        }

        .breadcrumbs a {
            color: var(--primary-color);
            text-decoration: none;
            cursor: pointer;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background-color: var(--widget-background);
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            border-radius: var(--border-radius);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 14px;
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 12px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 12px;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-danger {
            background-color: #dc3545;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 12px;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .loader-container {
            --uib-size: 40px;
            --uib-color: var(--primary-color);
            --uib-speed: .9s;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            align-items: center;
            justify-content: flex-start;
            height: var(--uib-size);
            width: var(--uib-size);
            animation: rotate calc(var(--uib-speed) * 3) linear infinite;
            z-index: 1002;
        }

        .dot {
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            height: 100%;
            width: 100%;
        }

        .dot::before {
            content: '';
            height: 20%;
            width: 20%;
            border-radius: 50%;
            background-color: var(--uib-color);
            animation: oscillate var(--uib-speed) ease-in-out infinite alternate;
        }

        .dot:nth-child(1)::before { transform: translateX(calc(var(--uib-size) / 2 - var(--uib-size) / 5 / 2)); }
        .dot:nth-child(2) { transform: rotate(45deg); }
        .dot:nth-child(2)::before { transform: translateX(calc(var(--uib-size) / 2 - var(--uib-size) / 5 / 2)); animation-delay: calc(var(--uib-speed) * -0.125); }
        .dot:nth-child(3) { transform: rotate(90deg); }
        .dot:nth-child(3)::before { transform: translateX(calc(var(--uib-size) / 2 - var(--uib-size) / 5 / 2)); animation-delay: calc(var(--uib-speed) * -0.25); }
        .dot:nth-child(4) { transform: rotate(135deg); }
        .dot:nth-child(4)::before { transform: translateX(calc(var(--uib-size) / 2 - var(--uib-size) / 5 / 2)); animation-delay: calc(var(--uib-speed) * -0.375); }
        .dot:nth-child(5) { transform: rotate(180deg); }
        .dot:nth-child(5)::before { transform: translateX(calc(var(--uib-size) / 2 - var(--uib-size) / 5 / 2)); animation-delay: calc(var(--uib-speed) * -0.5); }
        .dot:nth-child(6) { transform: rotate(225deg); }
        .dot:nth-child(6)::before { transform: translateX(calc(var(--uib-size) / 2 - var(--uib-size) / 5 / 2)); animation-delay: calc(var(--uib-speed) * -0.625); }
        .dot:nth-child(7) { transform: rotate(270deg); }
        .dot:nth-child(7)::before { transform: translateX(calc(var(--uib-size) / 2 - var(--uib-size) / 5 / 2)); animation-delay: calc(var(--uib-speed) * -0.75); }
        .dot:nth-child(8) { transform: rotate(315deg); }
        .dot:nth-child(8)::before { transform: translateX(calc(var(--uib-size) / 2 - var(--uib-size) / 5 / 2)); animation-delay: calc(var(--uib-speed) * -0.875); }

        @keyframes oscillate {
            0% { transform: translateX(calc(var(--uib-size) / 2 - var(--uib-size) / 5 / 2)) scale(0); opacity: 0.25; }
            100% { transform: translateX(0) scale(1); opacity: 1; }
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .widget {
            background-color: var(--widget-background);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 25px;
        }

        .widget h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }

        .stats {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .stats-number {
            font-size: 32px;
            font-weight: bold;
            color: var(--text-color);
        }

        .kanban-board {
            display: flex;
            gap: 25px;
            overflow-x: auto;
        }

        .kanban-column {
            flex: 1;
            min-width: 300px;
            background-color: var(--widget-background);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            min-height: 300px;
        }

        .kanban-column.todo { border-left: 4px solid #ffc107; }
        .kanban-column.in-progress { border-left: 4px solid #fd7e14; }
        .kanban-column.done { border-left: 4px solid #28a745; }
        .kanban-column.dragover { background-color: #3b4d64; }

        .kanban-column h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .table-container {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: auto;
            position: relative;
            width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--widget-background);
            box-shadow: var(--shadow);
            border-radius: var(--border-radius);
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #444;
            font-size: 12px;
            color: var(--text-color);
            white-space: nowrap;
        }

        th {
            background-color: var(--primary-color);
            color: #fff;
            font-weight: 600;
            text-transform: uppercase;
            position: sticky;
            top: 0;
            z-index: 2;
            cursor: pointer;
        }

        th:hover {
            background-color: #0056b3;
        }

        td {
            background-color: #34495e;
        }

        tr:nth-child(even) td {
            background-color: #3e5c76;
        }

        tr:hover td {
            background-color: #4a6a8a;
        }

        td select, td input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 12px;
            width: 100%;
            background-color: #fff;
            color: #333;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--widget-background);
            padding: 25px;
            border-radius: var(--border-radius);
            width: 450px;
            max-width: 90%;
            color: var(--text-color);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 24px;
            color: var(--text-color);
        }

        .notification {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--primary-color);
            color: #fff;
            padding: 12px 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            font-size: 14px;
            z-index: 1001;
        }

        .error-notification {
            background-color: #dc3545;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-size: 12px;
            color: var(--text-color);
        }

        .form-group label.required::after {
            content: '*';
            color: #dc3545;
            margin-left: 4px;
        }

        input, select, textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 12px;
            width: 100%;
            background-color: #fff;
            color: #333;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 4px var(--primary-color);
        }

        select {
            appearance: none;
            background: url('data:image/svg+xml;utf8,<svg fill="gray" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 10px center;
            background-size: 16px;
        }

        .list-item {
            background-color: var(--widget-background);
            padding: 14px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            border: 1px solid var(--secondary-color);
        }

        h2 {
            font-size: 24px;
            margin-bottom: 25px;
            color: var(--text-color);
        }

        .search-bar {
            margin-bottom: 20px;
        }

        .search-bar input {
            padding: 10px;
            width: 100%;
            max-width: 300px;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
            }

            .sidebar.collapsed {
                width: 60px;
            }

            .main-content {
                padding: 15px;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .header-right {
                flex-direction: column;
                align-items: flex-start;
            }

            .kanban-board {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container" style="display: none;">
        <div class="sidebar">
            <div class="sidebar-toggle">☰</div>
            <div class="sidebar-item active" data-tab="dashboard"><span>📊 Dashboard</span></div>
            <div class="sidebar-item" data-tab="daily-standup"><span>📅 Daily Standup</span></div>
            <div class="sidebar-item" data-tab="kanban-board"><span>📋 Scrum Board</span></div>
            <div class="sidebar-item" data-tab="project-management"><span>🏗️ Projects</span></div>
            <div class="sidebar-item" data-tab="project-overview"><span>🔍 Project Overview</span></div>
            <div class="sidebar-item" data-tab="approved-projects"><span>✅ Approved Projects</span></div>
            <div class="sidebar-item" data-tab="rejected-projects"><span>❌ Rejected Projects</span></div>
            <div class="sidebar-item" data-tab="project-types"><span>📑 Project Types</span></div>
            <div class="sidebar-item" data-tab="qa-report"><span>📈 QA Report</span></div>
            <div class="sidebar-item" data-tab="activity-log"><span>🕒 Activity Log</span></div>
            <div class="sidebar-item" data-tab="profile"><span>👤 Profile</span></div>
            <div class="sidebar-item" data-tab="user-management"><span>👥 User Management</span></div>
            <div class="sidebar-item" data-tab="assign-roles"><span>🔑 Assign Roles</span></div>
            <div class="sidebar-item" data-tab="testing-phases"><span>🧪 Testing Phases</span></div>
        </div>
        <div class="main-content">
            <div class="header">
                <div class="header-left">
                    <span style="font-size: 16px; font-weight: bold;">QA Team Dashboard</span>
                </div>
                <div class="header-right">
                    <div class="user-avatar" id="user-avatar"></div>
                    <span id="user-name"></span>
                    <button class="btn-primary" id="theme-toggle">Toggle Theme</button>
                    <button class="btn-primary" id="logout-btn">Logout</button>
                </div>
            </div>
            <div class="breadcrumbs" id="breadcrumbs"></div>
            <div id="notification" class="notification"></div>
            <div id="loader" class="loader-container">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
            <div id="dashboard" class="tab-pane active">
                <h2>Welcome, <span id="welcome-user"></span>!</h2>
                <div id="dashboard-content" class="stats-grid"></div>
            </div>
            <div id="daily-standup" class="tab-pane">
                <h2>Daily Standup</h2>
                <form id="standup-form">
                    <div class="form-group">
                        <label for="standup-yesterday" class="required">Yesterday’s Work</label>
                        <input type="text" id="standup-yesterday" placeholder="What did you do yesterday?" required>
                    </div>
                    <div class="form-group">
                        <label for="standup-today" class="required">Today’s Plan</label>
                        <input type="text" id="standup-today" placeholder="What will you do today?" required>
                    </div>
                    <div class="form-group">
                        <label for="standup-blockers">Blockers</label>
                        <input type="text" id="standup-blockers" placeholder="Any blockers?">
                    </div>
                    <button type="submit" class="btn-primary">Submit Standup</button>
                </form>
                <div class="widget" style="margin-top: 25px;">
                    <h3>Recent Standups (Last 2 Weeks)</h3>
                    <div class="table-container">
                        <table id="standup-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>User</th>
                                    <th>Yesterday’s Work</th>
                                    <th>Today’s Plan</th>
                                    <th>Blockers</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="kanban-board" class="tab-pane">
                <h2>Scrum Board</h2>
                <button class="btn-primary" onclick="showTaskForm()" style="margin-bottom: 25px;">Add Task</button>
                <div class="kanban-board">
                    <div class="kanban-column todo" ondrop="drop(event, 'To Do')" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                        <h3>To Do</h3>
                        <div id="to-do-tasks"></div>
                    </div>
                    <div class="kanban-column in-progress" ondrop="drop(event, 'In Progress')" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                        <h3>In Progress</h3>
                        <div id="in-progress-tasks"></div>
                    </div>
                    <div class="kanban-column done" ondrop="drop(event, 'Done')" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                        <h3>Done</h3>
                        <div id="done-tasks"></div>
                    </div>
                </div>
            </div>
            <div id="project-management" class="tab-pane">
                <h2>Projects</h2>
                <button class="btn-primary" onclick="showProjectForm()" style="margin-bottom: 25px;">Create Project</button>
                <div id="projects-list"></div>
            </div>
            <div id="project-overview" class="tab-pane">
                <h2>Project Overview</h2>
                <div class="search-bar">
                    <input type="text" id="project-search" placeholder="Search by project name, type, status, or QA" onkeyup="filterProjects()">
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Project Name</th>
                                <th>Assigned QA</th>
                                <th>Project Type</th>
                                <th>Current Phase</th>
                                <th>KT Received</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                                <th>Total Bugs</th>
                                <th>HTML Bugs</th>
                                <th>P0 HTML</th>
                                <th>P1 HTML</th>
                                <th>P2 HTML</th>
                                <th>P3 HTML</th>
                                <th>P4 HTML</th>
                                <th>Functional Bugs</th>
                                <th>P0 Func</th>
                                <th>P1 Func</th>
                                <th>P2 Func</th>
                                <th>P3 Func</th>
                                <th>P4 Func</th>
                                <th>Approved?</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="project-overview-table"></tbody>
                    </table>
                </div>
            </div>
            <div id="approved-projects" class="tab-pane">
                <h2>Approved Projects</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Project Name</th>
                                <th>Assigned QA</th>
                                <th>Project Type</th>
                                <th>Current Phase</th>
                                <th>KT Received</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                                <th>Approved Date</th>
                            </tr>
                        </thead>
                        <tbody id="approved-projects-table"></tbody>
                    </table>
                </div>
            </div>
            <div id="rejected-projects" class="tab-pane">
                <h2>Rejected Projects</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Project Name</th>
                                <th>Assigned QA</th>
                                <th>Project Type</th>
                                <th>Current Phase</th>
                                <th>KT Received</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                                <th>Rejection Date</th>
                                <th>Reason</th>
                                <th>Rejected By</th>
                            </tr>
                        </thead>
                        <tbody id="rejected-projects-table"></tbody>
                    </table>
                </div>
            </div>
            <div id="project-types" class="tab-pane">
                <h2>Project Types</h2>
                <button class="btn-primary" onclick="showCategoryForm()" style="margin-bottom: 25px;">Add Category</button>
                <div id="project-types-list"></div>
            </div>
            <div id="qa-report" class="tab-pane">
                <h2>QA Report</h2>
                <div class="filters" style="display: flex; gap: 15px; margin-bottom: 25px;">
                    <input type="month" id="report-filter-month" placeholder="Filter by Month">
                    <select id="report-filter-qa">
                        <option value="">All QAs</option>
                    </select>
                    <button class="btn-primary" onclick="renderReports()">Apply Filters</button>
                    <button class="btn-primary" onclick="exportReport()">Export Report</button>
                </div>
                <div id="reports-list">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Project Name</th>
                                    <th>QA</th>
                                    <th>Type</th>
                                    <th>Phase</th>
                                    <th>Status</th>
                                    <th>Total Bugs</th>
                                    <th>Approved?</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="activity-log" class="tab-pane">
                <h2>Activity Log</h2>
                <div id="activity-log-list"></div>
            </div>
            <div id="profile" class="tab-pane">
                <h2>Profile</h2>
                <form id="profile-form">
                    <div class="form-group">
                        <label for="profile-name" class="required">Your Name</label>
                        <input type="text" id="profile-name" required>
                    </div>
                    <div class="form-group">
                        <label for="profile-email" class="required">Email</label>
                        <input type="email" id="profile-email" required>
                    </div>
                    <div class="form-group">
                        <label for="profile-password">New Password</label>
                        <input type="password" id="profile-password" placeholder="Leave blank to keep current">
                    </div>
                    <button type="submit" class="btn-primary">Update Profile</button>
                </form>
            </div>
            <div id="user-management" class="tab-pane">
                <h2>User Management</h2>
                <button class="btn-primary" onclick="showUserForm()" style="margin-bottom: 25px;">Add User</button>
                <div id="users-list"></div>
            </div>
            <div id="assign-roles" class="tab-pane">
                <h2>Assign Roles</h2>
                <div id="roles-list"></div>
            </div>
            <div id="testing-phases" class="tab-pane">
                <h2>Testing Phases</h2>
                <button class="btn-primary" onclick="showPhaseForm()" style="margin-bottom: 25px;">Add Phase</button>
                <div id="testing-phases-list"></div>
            </div>
        </div>
    </div>
    <div id="login-modal" class="modal" style="display: flex;">
        <div class="modal-content">
            <span class="modal-close" onclick="closeLoginModal()">×</span>
            <h2>Login</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-email" class="required">Email</label>
                    <input type="email" id="login-email" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="login-password" class="required">Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn-primary">Login</button>
            </form>
        </div>
    </div>
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">×</span>
            <h2 id="modal-title"></h2>
            <div id="modal-body"></div>
        </div>
    </div>
    <div id="email-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">×</span>
            <h2>Email Draft</h2>
            <form id="email-form">
                <div class="form-group">
                    <label for="email-to" class="required">To</label>
                    <input type="email" id="email-to" required>
                </div>
                <div class="form-group">
                    <label for="email-subject" class="required">Subject</label>
                    <input type="text" id="email-subject" required>
                </div>
                <div class="form-group">
                    <label for="email-body" class="required">Body</label>
                    <textarea id="email-body" required></textarea>
                </div>
                <button type="submit" class="btn-primary">Send Email</button>
            </form>
        </div>
    </div>

    <script>
        let state = {
            currentUser: null,
            users: JSON.parse(localStorage.getItem('users')) || [],
            tasks: JSON.parse(localStorage.getItem('tasks')) || [],
            projects: JSON.parse(localStorage.getItem('projects')) || [],
            projectOverview: JSON.parse(localStorage.getItem('projectOverview')) || [],
            approvedProjects: JSON.parse(localStorage.getItem('approvedProjects')) || [],
            rejectedProjects: JSON.parse(localStorage.getItem('rejectedProjects')) || [],
            activityLog: JSON.parse(localStorage.getItem('activityLog')) || [],
            standupEntries: JSON.parse(localStorage.getItem('standupEntries')) || [],
            projectTypes: JSON.parse(localStorage.getItem('projectTypes')) || [],
            testingPhases: JSON.parse(localStorage.getItem('testingPhases')) || []
        };

        // Initialize predefined users with unique IDs
        if (!state.users.length) {
            state.users = [
                { id: '1', name: 'Admin User', email: 'qaadmin@intersmart.in', password: 'admin123', role: 'Admin' },
                { id: '2', name: 'Abhiram', email: 'abhiram@intersmart.in', password: 'lead123', role: 'Team Lead' },
                { id: '3', name: 'Aswathi', email: 'aswathi@intersmart.in', password: 'qa123', role: 'QA Member' },
                { id: '4', name: 'Minnu', email: 'minnu@intersmart.in', password: 'qa123', role: 'QA Member' }
            ];
            saveState('users', state.users);
        }

        function saveState(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                state[key] = data;
            } catch (e) {
                showNotification('LocalStorage error: ' + e.message, 3000, true);
            }
        }

        function logActivity(action) {
            state.activityLog.unshift({
                id: Date.now().toString(),
                action,
                user: state.currentUser ? state.currentUser.name : 'Unknown',
                timestamp: Date.now()
            });
            saveState('activityLog', state.activityLog.slice(0, 100));
            renderActivityLog();
        }

        function login(e) {
            e.preventDefault();
            showLoader(true);
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            const user = state.users.find(u => u.email === email && u.password === password);
            if (user) {
                state.currentUser = user;
                saveState('currentUser', user);
                document.getElementById('login-modal').style.display = 'none';
                document.querySelector('.container').style.display = 'flex';
                switchTab('dashboard');
                showNotification('Login successful!');
                document.getElementById('welcome-user').textContent = user.name;
                updateUserAvatar();
                setupSidebar();
                document.getElementById('login-form').reset();
                logActivity('User logged in');
            } else {
                showNotification('Invalid email or password', 3000, true);
            }
            showLoader(false);
        }

        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            state.currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
            if (!state.currentUser) {
                document.getElementById('login-modal').style.display = 'flex';
                document.querySelector('.container').style.display = 'none';
            } else {
                document.getElementById('login-modal').style.display = 'none';
                document.querySelector('.container').style.display = 'flex';
                updateUserAvatar();
                setupSidebar();
                switchTab('dashboard');
                renderAll();
            }

            document.getElementById('login-form').addEventListener('submit', login);
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('theme-toggle').addEventListener('click', () => {
                document.body.classList.toggle('light-theme');
                logActivity('Toggled theme');
            });
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', () => switchTab(item.getAttribute('data-tab')));
            });
            document.getElementById('standup-form').addEventListener('submit', submitStandup);
            document.getElementById('profile-form').addEventListener('submit', updateProfile);
            document.querySelector('.sidebar-toggle').addEventListener('click', toggleSidebar);
        });

        function closeLoginModal() {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('login-form').reset();
        }

        function updateUserAvatar() {
            const avatar = document.getElementById('user-avatar');
            const userName = document.getElementById('user-name');
            if (state.currentUser) {
                avatar.textContent = state.currentUser.name.charAt(0).toUpperCase();
                userName.textContent = state.currentUser.name;
            } else {
                avatar.textContent = '';
                userName.textContent = '';
            }
        }

        function logout() {
            state.currentUser = null;
            localStorage.clear();
            showNotification('Logged out successfully');
            updateUserAvatar();
            document.querySelector('.container').style.display = 'none';
            document.getElementById('login-modal').style.display = 'flex';
        }

        function setupSidebar() {
            document.querySelectorAll('.sidebar-item').forEach(item => {
                const tab = item.getAttribute('data-tab');
                item.style.display = 'flex';
                if (['project-management', 'activity-log', 'user-management', 'assign-roles', 'project-types', 'qa-report'].includes(tab)) {
                    item.style.display = (state.currentUser.role === 'Team Lead' || state.currentUser.role === 'Admin') ? 'flex' : 'none';
                }
            });
        }

        function renderAll() {
            renderUsers();
            renderAssignRoles();
            filterProjects();
            renderApprovedProjects();
            renderRejectedProjects();
            renderReports();
            renderTasks();
            renderStandup();
            renderActivityLog();
            renderTestingPhases();
            renderProjects();
            renderDashboard();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-pane').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
            const selectedTab = document.getElementById(tab);
            if (selectedTab) selectedTab.classList.add('active');
            document.querySelector(`.sidebar-item[data-tab="${tab}"]`)?.classList.add('active');
            document.getElementById('breadcrumbs').innerHTML = `<a href="#" onclick="switchTab('dashboard')">Home</a> / ${tab.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`;
            if (tab === 'dashboard') renderDashboard();
        }

        function renderDashboard() {
            if (state.currentUser) {
                document.getElementById('welcome-user').textContent = state.currentUser.name;
                const stats = calculateDashboardStats();
                document.getElementById('dashboard-content').innerHTML = Object.keys(stats).map(type => `
                    <div class="widget">
                        <h3>${type}</h3>
                        <div class="stats"><div class="stats-number">${stats[type].projects}</div><div>Total Projects</div></div>
                        <div class="stats"><div class="stats-number">${stats[type].pendingApprovals}</div><div>Pending Approvals</div></div>
                        <div class="stats"><div class="stats-number">${stats[type].completedProjects}</div><div>Completed Projects</div></div>
                    </div>
                `).join('');
            }
        }

        function showNotification(message, duration = 3000, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.toggle('error-notification', isError);
            notification.style.display = 'block';
            clearTimeout(notification.timeout);
            notification.timeout = setTimeout(() => notification.style.display = 'none', duration);
        }

        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('email-modal').style.display = 'none';
        }

        function submitStandup(e) {
            e.preventDefault();
            showLoader(true);
            const yesterday = document.getElementById('standup-yesterday').value.trim();
            const today = document.getElementById('standup-today').value.trim();
            const blockers = document.getElementById('standup-blockers').value.trim();
            if (!yesterday || !today) {
                showNotification('Yesterday’s work and today’s plan are required', 3000, true);
                showLoader(false);
                return;
            }
            const entry = {
                id: Date.now().toString(),
                userId: state.currentUser.id,
                userName: state.currentUser.name,
                date: new Date().toISOString().split('T')[0],
                yesterday,
                today,
                blockers,
                timestamp: Date.now()
            };
            state.standupEntries.unshift(entry);
            saveState('standupEntries', state.standupEntries.slice(0, 50));
            logActivity('Submitted daily standup');
            document.getElementById('standup-form').reset();
            showNotification('Standup submitted successfully');
            renderStandup();
            showLoader(false);
        }

        function renderStandup() {
            const tbody = document.querySelector('#standup-table tbody');
            tbody.innerHTML = '';
            let filteredEntries = state.standupEntries.filter(entry => 
                new Date().getTime() - new Date(entry.date).getTime() <= 14 * 24 * 60 * 60 * 1000
            );
            if (state.currentUser.role === 'QA Member') {
                filteredEntries = filteredEntries.filter(entry => entry.userId === state.currentUser.id);
            }
            filteredEntries.forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td>${entry.userName}</td>
                    <td>${entry.yesterday}</td>
                    <td>${entry.today}</td>
                    <td>${entry.blockers || 'None'}</td>
                    <td>
                        ${(state.currentUser.id === entry.userId || state.currentUser.role === 'Team Lead' || state.currentUser.role === 'Admin') ? `
                            <button class="btn-primary" onclick="editStandup('${entry.id}')">Edit</button>
                            <button class="btn-danger" onclick="deleteStandup('${entry.id}')">Delete</button>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editStandup(id) {
            const entry = state.standupEntries.find(e => e.id === id);
            if (!entry || (state.currentUser.id !== entry.userId && state.currentUser.role !== 'Team Lead' && state.currentUser.role !== 'Admin')) return;
            const content = `
                <form id="edit-standup-form">
                    <div class="form-group">
                        <label for="edit-yesterday" class="required">Yesterday’s Work</label>
                        <input type="text" id="edit-yesterday" value="${entry.yesterday}" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-today" class="required">Today’s Plan</label>
                        <input type="text" id="edit-today" value="${entry.today}" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-blockers">Blockers</label>
                        <input type="text" id="edit-blockers" value="${entry.blockers || ''}">
                    </div>
                    <button type="submit" class="btn-primary">Update Standup</button>
                </form>
            `;
            showModal('Edit Standup', content);
            document.getElementById('edit-standup-form').onsubmit = (e) => {
                e.preventDefault();
                const yesterday = document.getElementById('edit-yesterday').value.trim();
                const today = document.getElementById('edit-today').value.trim();
                const blockers = document.getElementById('edit-blockers').value.trim();
                if (!yesterday || !today) {
                    showNotification('Yesterday’s work and today’s plan are required', 3000, true);
                    return;
                }
                const index = state.standupEntries.findIndex(e => e.id === id);
                state.standupEntries[index] = { ...entry, yesterday, today, blockers };
                saveState('standupEntries', state.standupEntries);
                logActivity('Updated standup entry');
                closeModal();
                showNotification('Standup updated successfully');
                renderStandup();
            };
        }

        function deleteStandup(id) {
            const entry = state.standupEntries.find(e => e.id === id);
            if (!entry || (state.currentUser.id !== entry.userId && state.currentUser.role !== 'Team Lead' && state.currentUser.role !== 'Admin')) {
                showNotification('You cannot delete this standup', 3000, true);
                return;
            }
            state.standupEntries = state.standupEntries.filter(e => e.id !== id);
            saveState('standupEntries', state.standupEntries);
            logActivity('Deleted standup entry');
            showNotification('Standup deleted successfully');
            renderStandup();
        }

        function showTaskForm(taskId = null) {
            const task = taskId ? state.tasks.find(t => t.id === taskId) : null;
            if (task && state.currentUser.role === 'QA Member' && task.createdBy !== state.currentUser.id) {
                showNotification('You cannot edit this task', 3000, true);
                return;
            }
            const content = `
                <form id="task-form">
                    <div class="form-group">
                        <label for="task-title" class="required">Task Title</label>
                        <input type="text" id="task-title" value="${task ? task.title : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="task-project" class="required">Project</label>
                        <select id="task-project" required>
                            <option value="">Select Project</option>
                            ${state.projects.map(project => `
                                <option value="${project.id}" ${task && task.projectId === project.id ? 'selected' : ''}>${project.name}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="task-phase" class="required">Phase</label>
                        <select id="task-phase" required>
                            <option value="">Select Phase</option>
                            ${state.testingPhases.map(phase => `
                                <option value="${phase.name}" ${task && task.phase === phase.name ? 'selected' : ''}>${phase.name}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="task-assignee">Assignee</label>
                        <select id="task-assignee">
                            <option value="">Unassigned</option>
                            ${state.users.map(user => `
                                <option value="${user.id}" ${task && task.assignee === user.id ? 'selected' : ''}>${user.name}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="task-status" class="required">Status</label>
                        <select id="task-status" required>
                            <option value="To Do" ${task && task.status === 'To Do' ? 'selected' : ''}>To Do</option>
                            <option value="In Progress" ${task && task.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                            <option value="Done" ${task && task.status === 'Done' ? 'selected' : ''}>Done</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary">${task ? 'Update' : 'Add'} Task</button>
                </form>
            `;
            showModal(`${task ? 'Edit' : 'Add'} Task`, content);
            document.getElementById('task-form').onsubmit = (e) => {
                e.preventDefault();
                const title = document.getElementById('task-title').value.trim();
                const projectId = document.getElementById('task-project').value;
                const phase = document.getElementById('task-phase').value;
                const assignee = document.getElementById('task-assignee').value;
                const status = document.getElementById('task-status').value;
                if (!title || !projectId || !phase || !status) {
                    showNotification('All required fields must be filled', 3000, true);
                    return;
                }
                if (task) {
                    const index = state.tasks.findIndex(t => t.id === taskId);
                    state.tasks[index] = { ...task, title, projectId, phase, assignee, status };
                    logActivity(`Updated task: ${title}`);
                } else {
                    state.tasks.push({
                        id: Date.now().toString(),
                        title,
                        projectId,
                        phase,
                        assignee,
                        status,
                        createdBy: state.currentUser.id,
                        createdAt: Date.now()
                    });
                    logActivity(`Added task: ${title}`);
                }
                saveState('tasks', state.tasks);
                updateProjectOverview({ projectId, phase, status });
                closeModal();
                showNotification('Task saved successfully');
                renderTasks();
                filterProjects();
            };
        }

        function renderTasks() {
            const toDo = document.getElementById('to-do-tasks');
            const inProgress = document.getElementById('in-progress-tasks');
            const done = document.getElementById('done-tasks');
            toDo.innerHTML = inProgress.innerHTML = done.innerHTML = '';
            state.tasks.forEach(task => {
                if (state.currentUser.role === 'QA Member' && task.assignee !== state.currentUser.id && task.createdBy !== state.currentUser.id) return;
                const taskElement = document.createElement('div');
                taskElement.className = 'list-item';
                taskElement.draggable = true;
                taskElement.ondragstart = (e) => drag(e, task.id);
                taskElement.innerHTML = `
                    <span>${task.title} (${state.users.find(u => u.id === task.assignee)?.name || 'Unassigned'})</span>
                    <div>
                        ${(state.currentUser.role === 'Admin' || state.currentUser.role === 'Team Lead' || task.createdBy === state.currentUser.id) ? `
                            <button class="btn-primary" onclick="showTaskForm('${task.id}')">Edit</button>
                            <button class="btn-danger" onclick="deleteTask('${task.id}')">Delete</button>
                        ` : ''}
                    </div>
                `;
                if (task.status === 'To Do') toDo.appendChild(taskElement);
                else if (task.status === 'In Progress') inProgress.appendChild(taskElement);
                else if (task.status === 'Done') done.appendChild(taskElement);
            });
        }

        function updateProjectOverview(task) {
            const projectIndex = state.projectOverview.findIndex(p => p.projectId === task.projectId);
            if (projectIndex === -1) {
                const project = state.projects.find(p => p.id === task.projectId);
                if (project) {
                    state.projectOverview.push({
                        projectId: project.id,
                        projectName: project.name,
                        qaId: task.assignee || '',
                        projectType: project.category,
                        currentPhase: task.phase,
                        ktReceived: 'No',
                        startDate: new Date().toISOString().split('T')[0],
                        endDate: '',
                        status: task.status === 'Done' ? 'Completed' : 'In Progress',
                        totalBugs: 0,
                        htmlBugs: 0,
                        p0HtmlBugs: 0,
                        p1HtmlBugs: 0,
                        p2HtmlBugs: 0,
                        p3HtmlBugs: 0,
                        p4HtmlBugs: 0,
                        functionalBugs: 0,
                        p0FunctionalBugs: 0,
                        p1FunctionalBugs: 0,
                        p2FunctionalBugs: 0,
                        p3FunctionalBugs: 0,
                        p4FunctionalBugs: 0,
                        tlApproval: 'No'
                    });
                }
            } else {
                state.projectOverview[projectIndex].currentPhase = task.phase;
                state.projectOverview[projectIndex].status = task.status === 'Done' ? 'Completed' : 'In Progress';
                if (task.assignee) state.projectOverview[projectIndex].qaId = task.assignee;
            }
            saveState('projectOverview', state.projectOverview);
        }

        function drag(e, taskId) {
            e.dataTransfer.setData('text/plain', taskId);
        }

        function allowDrop(e) {
            e.preventDefault();
        }

        function dragEnter(e) {
            e.target.classList.add('dragover');
        }

        function dragLeave(e) {
            e.target.classList.remove('dragover');
        }

        function drop(e, status) {
            e.preventDefault();
            e.target.classList.remove('dragover');
            const taskId = e.dataTransfer.getData('text/plain');
            const task = state.tasks.find(t => t.id === taskId);
            if (!task || (state.currentUser.role === 'QA Member' && task.createdBy !== state.currentUser.id && task.assignee !== state.currentUser.id)) {
                showNotification('You cannot move this task', 3000, true);
                return;
            }
            const index = state.tasks.findIndex(t => t.id === taskId);
            state.tasks[index].status = status;
            logActivity(`Moved task "${task.title}" to ${status}`);
            saveState('tasks', state.tasks);
            updateProjectOverview(task);
            renderTasks();
            filterProjects();
        }

        function deleteTask(taskId) {
            const task = state.tasks.find(t => t.id === taskId);
            if (!task || (state.currentUser.role === 'QA Member' && task.createdBy !== state.currentUser.id)) {
                showNotification('You cannot delete this task', 3000, true);
                return;
            }
            state.tasks = state.tasks.filter(t => t.id !== taskId);
            logActivity(`Deleted task: ${task.title}`);
            saveState('tasks', state.tasks);
            showNotification('Task deleted successfully');
            renderTasks();
            filterProjects();
        }

        function showProjectForm(projectId = null) {
            const project = projectId ? state.projects.find(p => p.id === projectId) : null;
            if (project && state.currentUser.role !== 'Admin' && state.currentUser.role !== 'Team Lead') {
                showNotification('Only Admins or Team Leads can edit projects', 3000, true);
                return;
            }
            const content = `
                <form id="project-form">
                    <div class="form-group">
                        <label for="project-name" class="required">Project Name</label>
                        <input type="text" id="project-name" value="${project ? project.name : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="project-category" class="required">Project Category</label>
                        <select id="project-category" required onchange="populateSubcategories()">
                            <option value="">Select Category</option>
                            ${state.projectTypes.map(category => `
                                <option value="${category.name}" ${project && project.category === category.name ? 'selected' : ''}>${category.name}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="project-subcategory" class="required">Project Subcategory</label>
                        <select id="project-subcategory" required>
                            <option value="">Select Subcategory</option>
                            ${project ? state.projectTypes.find(c => c.name === project.category)?.subcategories.map(sub => `
                                <option value="${sub}" ${project.subcategory === sub ? 'selected' : ''}>${sub}</option>
                            `).join('') : ''}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="project-link" class="required">GitLab/Bugtracker Link</label>
                        <input type="url" id="project-link" value="${project ? project.link : ''}" required>
                    </div>
                    <button type="submit" class="btn-primary">${project ? 'Update' : 'Create'} Project</button>
                </form>
            `;
            showModal(`${project ? 'Edit' : 'Create'} Project`, content);
            document.getElementById('project-form').onsubmit = (e) => {
                e.preventDefault();
                const name = document.getElementById('project-name').value.trim();
                const category = document.getElementById('project-category').value;
                const subcategory = document.getElementById('project-subcategory').value;
                const link = document.getElementById('project-link').value.trim();
                if (!name || !category || !subcategory || !link) {
                    showNotification('All fields are required', 3000, true);
                    return;
                }
                if (project) {
                    const index = state.projects.findIndex(p => p.id === projectId);
                    state.projects[index] = { ...project, name, category, subcategory, link };
                    logActivity(`Updated project: ${name}`);
                } else {
                    state.projects.push({
                        id: Date.now().toString(),
                        name,
                        category,
                        subcategory,
                        link,
                        createdBy: state.currentUser.id,
                        createdAt: Date.now()
                    });
                    logActivity(`Created project: ${name}`);
                }
                saveState('projects', state.projects);
                closeModal();
                showNotification('Project saved successfully');
                renderProjects();
                filterProjects();
            };
        }

        function populateSubcategories() {
            const category = document.getElementById('project-category').value;
            const subcategoryDropdown = document.getElementById('project-subcategory');
            subcategoryDropdown.innerHTML = '<option value="">Select Subcategory</option>';
            const selectedCategory = state.projectTypes.find(c => c.name === category);
            if (selectedCategory) {
                subcategoryDropdown.innerHTML += selectedCategory.subcategories.map(sub => `
                    <option value="${sub}">${sub}</option>
                `).join('');
            }
        }

        function addNewPhase(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project || state.currentUser.role !== 'QA Member') {
                showNotification('Only QA Members can add new phases', 3000, true);
                return;
            }
            const content = `
                <form id="phase-form">
                    <div class="form-group">
                        <label for="new-phase" class="required">New Phase</label>
                        <select id="new-phase" required>
                            <option value="">Select Phase</option>
                            ${state.testingPhases.map(phase => `<option value="${phase.name}">${phase.name}</option>`).join('')}
                        </select>
                    </div>
                    <button type="submit" class="btn-primary">Add Phase</button>
                </form>
            `;
            showModal('Add New Phase', content);
            document.getElementById('phase-form').onsubmit = (e) => {
                e.preventDefault();
                const newPhase = document.getElementById('new-phase').value;
                if (!newPhase) {
                    showNotification('Phase is required', 3000, true);
                    return;
                }
                const existing = state.projectOverview.find(p => p.projectId === projectId && p.currentPhase === newPhase);
                if (existing) {
                    showNotification('This phase already exists for the project', 3000, true);
                    return;
                }
                state.projectOverview.push({
                    projectId,
                    projectName: project.name,
                    qaId: state.currentUser.id,
                    projectType: project.category,
                    currentPhase: newPhase,
                    ktReceived: 'No',
                    startDate: new Date().toISOString().split('T')[0],
                    endDate: '',
                    status: 'In Progress',
                    totalBugs: 0,
                    htmlBugs: 0,
                    p0HtmlBugs: 0,
                    p1HtmlBugs: 0,
                    p2HtmlBugs: 0,
                    p3HtmlBugs: 0,
                    p4HtmlBugs: 0,
                    functionalBugs: 0,
                    p0FunctionalBugs: 0,
                    p1FunctionalBugs: 0,
                    p2FunctionalBugs: 0,
                    p3FunctionalBugs: 0,
                    p4FunctionalBugs: 0,
                    tlApproval: 'No'
                });
                logActivity(`Started new phase "${newPhase}" for project "${project.name}"`);
                saveState('projectOverview', state.projectOverview);
                closeModal();
                showNotification('Phase added successfully');
                filterProjects();
            };
        }

        function updatePhase(projectId, phase) {
            const index = state.projectOverview.findIndex(p => p.projectId === projectId);
            if (index === -1) return;
            state.projectOverview[index].currentPhase = phase;
            logActivity(`Updated phase of project "${state.projectOverview[index].projectName}" to ${phase}`);
            saveState('projectOverview', state.projectOverview);
            showNotification('Phase updated successfully');
            filterProjects();
        }

        function updateKT(projectId, ktReceived) {
            const index = state.projectOverview.findIndex(p => p.projectId === projectId);
            if (index === -1) return;
            state.projectOverview[index].ktReceived = ktReceived;
            logActivity(`Updated KT status of "${state.projectOverview[index].projectName}" to ${ktReceived}`);
            saveState('projectOverview', state.projectOverview);
            showNotification('KT status updated successfully');
            filterProjects();
        }

        function submitForTLApproval(projectId) {
            const index = state.projectOverview.findIndex(p => p.projectId === projectId);
            if (index === -1 || state.currentUser.role !== 'QA Member') {
                showNotification('Only QA Members can submit for approval', 3000, true);
                return;
            }
            state.projectOverview[index].tlApproval = 'Awaiting Approval';
            logActivity(`Submitted project "${state.projectOverview[index].projectName}" for TL approval`);
            saveState('projectOverview', state.projectOverview);
            showNotification('Project submitted for TL approval');
            filterProjects();
        }

        function updateApproval(projectId, approvedForLive) {
            const index = state.projectOverview.findIndex(p => p.projectId === projectId);
            if (index === -1 || (state.currentUser.role !== 'Team Lead' && state.currentUser.role !== 'Admin')) {
                showNotification('Only Team Leads or Admins can approve projects', 3000, true);
                return;
            }
            const project = state.projectOverview[index];
            if (approvedForLive === 'Yes') {
                state.approvedProjects.push({
                    ...project,
                    approvedForLive: 'Yes',
                    approvedDate: new Date().toISOString().split('T')[0],
                    approvedBy: state.currentUser.name,
                    endDate: project.endDate || new Date().toISOString().split('T')[0]
                });
                state.projectOverview.splice(index, 1);
                logActivity(`Approved "${project.projectName}" for live`);
                saveState('approvedProjects', state.approvedProjects);
                sendEmail(project.projectId, 'Approved');
            } else if (approvedForLive === 'Rejected') {
                const reason = prompt('Please provide a reason for rejection:');
                if (!reason) {
                    showNotification('Rejection reason is required', 3000, true);
                    return;
                }
                state.rejectedProjects.push({
                    ...project,
                    approvedForLive: 'Rejected',
                    rejectionDate: new Date().toISOString().split('T')[0],
                    rejectionReason: reason,
                    rejectedBy: state.currentUser.name,
                    endDate: project.endDate || new Date().toISOString().split('T')[0]
                });
                state.projectOverview.splice(index, 1);
                logActivity(`Rejected "${project.projectName}" - Reason: ${reason}`);
                saveState('rejectedProjects', state.rejectedProjects);
                sendEmail(project.projectId, 'Rejected', reason);
            } else {
                state.projectOverview[index].tlApproval = 'No';
                logActivity(`Set "${project.projectName}" approval to No`);
                showNotification('Project approval updated');
            }
            saveState('projectOverview', state.projectOverview);
            filterProjects();
            renderApprovedProjects();
            renderRejectedProjects();
        }

        function sendEmail(projectId, status, reason = '') {
            const project = state.projects.find(p => p.id === projectId);
            const overview = state.projectOverview.find(p => p.projectId === projectId) || state.approvedProjects.find(p => p.projectId === projectId) || state.rejectedProjects.find(p => p.projectId === projectId);
            const content = `
                <form id="email-form">
                    <div class="form-group">
                        <label for="email-to" class="required">To</label>
                        <input type="email" id="email-to" value="coordinator@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="email-subject" class="required">Subject</label>
                        <input type="text" id="email-subject" value="${status} - ${project.name}" required>
                    </div>
                    <div class="form-group">
                        <label for="email-body" class="required">Body</label>
                        <textarea id="email-body" required>Dear Coordinator,\n\nProject "${project.name}" has been ${status.toLowerCase()}.\nTotal Bugs: ${overview.totalBugs || 0}\nTesting Time: ${overview.startDate} to ${overview.endDate || 'Ongoing'}\n${reason ? `Reason: ${reason}\n` : ''}Regards,\n${state.currentUser.name}</textarea>
                    </div>
                    <button type="submit" class="btn-primary">Send Email</button>
                </form>
            `;
            document.getElementById('email-modal').style.display = 'flex';
            document.getElementById('email-form').onsubmit = (e) => {
                e.preventDefault();
                const to = document.getElementById('email-to').value.trim();
                const subject = document.getElementById('email-subject').value.trim();
                const body = document.getElementById('email-body').value.trim();
                if (!to || !subject || !body) {
                    showNotification('All email fields are required', 3000, true);
                    return;
                }
                logActivity(`Sent email for "${project.name}" - ${status}`);
                closeModal();
                showNotification('Email sent (simulated)');
            };
        }

        function filterProjects() {
            const search = document.getElementById('project-search')?.value.toLowerCase() || '';
            const tbody = document.getElementById('project-overview-table');
            tbody.innerHTML = '';
            let filteredProjects = state.projectOverview;
            if (state.currentUser.role === 'QA Member') {
                filteredProjects = filteredProjects.filter(p => p.qaId === state.currentUser.id);
            }
            filteredProjects = filteredProjects.filter(p =>
                p.projectName.toLowerCase().includes(search) ||
                p.projectType.toLowerCase().includes(search) ||
                p.status.toLowerCase().includes(search) ||
                (state.users.find(u => u.id === p.qaId)?.name || '').toLowerCase().includes(search)
            );
            filteredProjects.forEach(project => {
                const qa = state.users.find(u => u.id === project.qaId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${project.projectName}</td>
                    <td>${qa ? qa.name : 'Unassigned'}</td>
                    <td>${project.projectType}</td>
                    <td>
                        <select onchange="updatePhase('${project.projectId}', this.value)">
                            <option value="Not Started" ${project.currentPhase === 'Not Started' ? 'selected' : ''}>Not Started</option>
                            ${state.testingPhases.map(phase => `
                                <option value="${phase.name}" ${project.currentPhase === phase.name ? 'selected' : ''}>${phase.name}</option>
                            `).join('')}
                        </select>
                    </td>
                    <td>
                        <select onchange="updateKT('${project.projectId}', this.value)">
                            <option value="Yes" ${project.ktReceived === 'Yes' ? 'selected' : ''}>Yes</option>
                            <option value="No" ${project.ktReceived === 'No' ? 'selected' : ''}>No</option>
                        </select>
                    </td>
                    <td>${project.startDate}</td>
                    <td>${project.endDate || 'N/A'}</td>
                    <td>${project.status}</td>
                    <td>${project.totalBugs || 0}</td>
                    <td>${project.htmlBugs || 0}</td>
                    <td>${project.p0HtmlBugs || 0}</td>
                    <td>${project.p1HtmlBugs || 0}</td>
                    <td>${project.p2HtmlBugs || 0}</td>
                    <td>${project.p3HtmlBugs || 0}</td>
                    <td>${project.p4HtmlBugs || 0}</td>
                    <td>${project.functionalBugs || 0}</td>
                    <td>${project.p0FunctionalBugs || 0}</td>
                    <td>${project.p1FunctionalBugs || 0}</td>
                    <td>${project.p2FunctionalBugs || 0}</td>
                    <td>${project.p3FunctionalBugs || 0}</td>
                    <td>${project.p4FunctionalBugs || 0}</td>
                    <td>
                        ${project.tlApproval === 'Awaiting Approval' && (state.currentUser.role === 'Team Lead' || state.currentUser.role === 'Admin') ? `
                            <select onchange="updateApproval('${project.projectId}', this.value)">
                                <option value="No" ${project.tlApproval === 'No' ? 'selected' : ''}>No</option>
                                <option value="Yes">Yes</option>
                                <option value="Rejected">Reject</option>
                            </select>
                        ` : project.tlApproval}
                    </td>
                    <td>
                        ${state.currentUser.role === 'Admin' ? `
                            <button class="btn-primary" onclick="showProjectForm('${project.projectId}')">Edit</button>
                            <button class="btn-danger" onclick="deleteProject('${project.projectId}')">Delete</button>
                        ` : ''}
                        ${state.currentUser.role === 'QA Member' && project.qaId === state.currentUser.id ? `
                            <button class="btn-primary" onclick="addNewPhase('${project.projectId}')">New Phase</button>
                            <button class="btn-primary" onclick="submitForTLApproval('${project.projectId}')">Submit for Approval</button>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function deleteProject(projectId) {
            if (state.currentUser.role !== 'Admin') {
                showNotification('Only Admins can delete projects', 3000, true);
                return;
            }
            const project = state.projects.find(p => p.id === projectId);
            state.projects = state.projects.filter(p => p.id !== projectId);
            state.projectOverview = state.projectOverview.filter(p => p.projectId !== projectId);
            state.tasks = state.tasks.filter(t => t.projectId !== projectId);
            logActivity(`Deleted project: ${project.name}`);
            saveState('projects', state.projects);
            saveState('projectOverview', state.projectOverview);
            saveState('tasks', state.tasks);
            showNotification('Project deleted successfully');
            renderProjects();
            filterProjects();
            renderTasks();
        }

        function renderApprovedProjects() {
            const tbody = document.getElementById('approved-projects-table');
            tbody.innerHTML = '';
            let filteredProjects = state.approvedProjects;
            if (state.currentUser.role === 'QA Member') {
                filteredProjects = filteredProjects.filter(p => p.qaId === state.currentUser.id);
            }
            filteredProjects.forEach(project => {
                const qa = state.users.find(u => u.id === project.qaId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${project.projectName}</td>
                    <td>${qa ? qa.name : 'Unassigned'}</td>
                    <td>${project.projectType}</td>
                    <td>${project.currentPhase}</td>
                    <td>${project.ktReceived}</td>
                    <td>${project.startDate}</td>
                    <td>${project.endDate || 'N/A'}</td>
                    <td>${project.status}</td>
                    <td>${project.approvedDate}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderRejectedProjects() {
            const tbody = document.getElementById('rejected-projects-table');
            tbody.innerHTML = '';
            let filteredProjects = state.rejectedProjects;
            if (state.currentUser.role === 'QA Member') {
                filteredProjects = filteredProjects.filter(p => p.qaId === state.currentUser.id);
            }
            filteredProjects.forEach(project => {
                const qa = state.users.find(u => u.id === project.qaId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${project.projectName}</td>
                    <td>${qa ? qa.name : 'Unassigned'}</td>
                    <td>${project.projectType}</td>
                    <td>${project.currentPhase}</td>
                    <td>${project.ktReceived}</td>
                    <td>${project.startDate}</td>
                    <td>${project.endDate || 'N/A'}</td>
                    <td>${project.status}</td>
                    <td>${project.rejectionDate}</td>
                    <td>${project.rejectionReason}</td>
                    <td>${project.rejectedBy}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function showCategoryForm(categoryId = null) {
            if (state.currentUser.role !== 'Admin' && state.currentUser.role !== 'Team Lead') {
                showNotification('Only Admins or Team Leads can manage project types', 3000, true);
                return;
            }
            const category = categoryId ? state.projectTypes.find(c => c.id === categoryId) : null;
            const content = `
                <form id="category-form">
                    <div class="form-group">
                        <label for="category-name" class="required">Category Name</label>
                        <input type="text" id="category-name" value="${category ? category.name : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="category-subcategories" class="required">Subcategories (comma-separated)</label>
                        <input type="text" id="category-subcategories" value="${category ? category.subcategories.join(', ') : ''}" required>
                    </div>
                    <button type="submit" class="btn-primary">${category ? 'Update' : 'Add'} Category</button>
                </form>
            `;
            showModal(`${category ? 'Edit' : 'Add'} Category`, content);
            document.getElementById('category-form').onsubmit = (e) => {
                e.preventDefault();
                const name = document.getElementById('category-name').value.trim();
                const subcategories = document.getElementById('category-subcategories').value.split(',').map(s => s.trim()).filter(s => s);
                if (!name || !subcategories.length) {
                    showNotification('Category name and at least one subcategory are required', 3000, true);
                    return;
                }
                if (category) {
                    javascript

Collapse

Wrap

Copy
                    const index = state.projectTypes.findIndex(c => c.id === categoryId);
                    state.projectTypes[index] = { ...category, name, subcategories };
                    logActivity(`Updated project category: ${name}`);
                } else {
                    state.projectTypes.push({
                        id: Date.now().toString(),
                        name,
                        subcategories
                    });
                    logActivity(`Added project category: ${name}`);
                }
                saveState('projectTypes', state.projectTypes);
                closeModal();
                showNotification('Category saved successfully');
                renderProjectTypes();
            };
        }

        function renderProjectTypes() {
            const list = document.getElementById('project-types-list');
            list.innerHTML = '';
            state.projectTypes.forEach(category => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <span>${category.name} (${category.subcategories.join(', ')})</span>
                    ${(state.currentUser.role === 'Admin' || state.currentUser.role === 'Team Lead') ? `
                        <div>
                            <button class="btn-primary" onclick="showCategoryForm('${category.id}')">Edit</button>
                            <button class="btn-danger" onclick="deleteCategory('${category.id}')">Delete</button>
                        </div>
                    ` : ''}
                `;
                list.appendChild(item);
            });
        }

        function deleteCategory(categoryId) {
            if (state.currentUser.role !== 'Admin' && state.currentUser.role !== 'Team Lead') {
                showNotification('Only Admins or Team Leads can delete categories', 3000, true);
                return;
            }
            const category = state.projectTypes.find(c => c.id === categoryId);
            state.projectTypes = state.projectTypes.filter(c => c.id !== categoryId);
            logActivity(`Deleted project category: ${category.name}`);
            saveState('projectTypes', state.projectTypes);
            showNotification('Category deleted successfully');
            renderProjectTypes();
        }

        function showPhaseForm(phaseId = null) {
            if (state.currentUser.role !== 'Admin' && state.currentUser.role !== 'Team Lead') {
                showNotification('Only Admins or Team Leads can manage testing phases', 3000, true);
                return;
            }
            const phase = phaseId ? state.testingPhases.find(p => p.id === phaseId) : null;
            const content = `
                <form id="phase-form">
                    <div class="form-group">
                        <label for="phase-name" class="required">Phase Name</label>
                        <input type="text" id="phase-name" value="${phase ? phase.name : ''}" required>
                    </div>
                    <button type="submit" class="btn-primary">${phase ? 'Update' : 'Add'} Phase</button>
                </form>
            `;
            showModal(`${phase ? 'Edit' : 'Add'} Phase`, content);
            document.getElementById('phase-form').onsubmit = (e) => {
                e.preventDefault();
                const name = document.getElementById('phase-name').value.trim();
                if (!name) {
                    showNotification('Phase name is required', 3000, true);
                    return;
                }
                if (phase) {
                    const index = state.testingPhases.findIndex(p => p.id === phaseId);
                    state.testingPhases[index] = { ...phase, name };
                    logActivity(`Updated testing phase: ${name}`);
                } else {
                    state.testingPhases.push({
                        id: Date.now().toString(),
                        name
                    });
                    logActivity(`Added testing phase: ${name}`);
                }
                saveState('testingPhases', state.testingPhases);
                closeModal();
                showNotification('Phase saved successfully');
                renderTestingPhases();
            };
        }

        function renderTestingPhases() {
            const list = document.getElementById('testing-phases-list');
            list.innerHTML = '';
            state.testingPhases.forEach(phase => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <span>${phase.name}</span>
                    ${(state.currentUser.role === 'Admin' || state.currentUser.role === 'Team Lead') ? `
                        <div>
                            <button class="btn-primary" onclick="showPhaseForm('${phase.id}')">Edit</button>
                            <button class="btn-danger" onclick="deletePhase('${phase.id}')">Delete</button>
                        </div>
                    ` : ''}
                `;
                list.appendChild(item);
            });
        }

        function deletePhase(phaseId) {
            if (state.currentUser.role !== 'Admin' && state.currentUser.role !== 'Team Lead') {
                showNotification('Only Admins or Team Leads can delete phases', 3000, true);
                return;
            }
            const phase = state.testingPhases.find(p => p.id === phaseId);
            state.testingPhases = state.testingPhases.filter(p => p.id !== phaseId);
            logActivity(`Deleted testing phase: ${phase.name}`);
            saveState('testingPhases', state.testingPhases);
            showNotification('Phase deleted successfully');
            renderTestingPhases();
        }

        function renderReports() {
            const monthFilter = document.getElementById('report-filter-month')?.value || '';
            const qaFilter = document.getElementById('report-filter-qa')?.value || '';
            const tbody = document.querySelector('#reports-list tbody');
            tbody.innerHTML = '';

            // Populate QA filter dropdown
            const qaSelect = document.getElementById('report-filter-qa');
            qaSelect.innerHTML = '<option value="">All QAs</option>' + state.users
                .filter(u => u.role === 'QA Member' || u.role === 'Team Lead')
                .map(u => `<option value="${u.id}">${u.name}</option>`).join('');

            let filteredProjects = [...state.projectOverview, ...state.approvedProjects, ...state.rejectedProjects];
            if (monthFilter) {
                const [year, month] = monthFilter.split('-');
                filteredProjects = filteredProjects.filter(p => {
                    const date = p.startDate || p.approvedDate || p.rejectionDate;
                    return date.startsWith(`${year}-${month}`);
                });
            }
            if (qaFilter) {
                filteredProjects = filteredProjects.filter(p => p.qaId === qaFilter);
            }
            if (state.currentUser.role === 'QA Member') {
                filteredProjects = filteredProjects.filter(p => p.qaId === state.currentUser.id);
            }

            filteredProjects.forEach(project => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${project.projectName}</td>
                    <td>${state.users.find(u => u.id === project.qaId)?.name || 'Unassigned'}</td>
                    <td>${project.projectType}</td>
                    <td>${project.currentPhase}</td>
                    <td>${project.status}</td>
                    <td>${project.totalBugs || 0}</td>
                    <td>${project.approvedForLive || 'No'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function exportReport() {
            const monthFilter = document.getElementById('report-filter-month')?.value || 'All Time';
            const qaFilter = document.getElementById('report-filter-qa')?.value;
            const qaName = qaFilter ? state.users.find(u => u.id === qaFilter)?.name : 'All QAs';
            let csv = 'Project Name,QA,Type,Phase,Status,Total Bugs,Approved?\n';
            const filteredProjects = [...state.projectOverview, ...state.approvedProjects, ...state.rejectedProjects]
                .filter(p => (!monthFilter || p.startDate?.startsWith(monthFilter)) && (!qaFilter || p.qaId === qaFilter))
                .filter(p => state.currentUser.role !== 'QA Member' || p.qaId === state.currentUser.id);
            csv += filteredProjects.map(p => 
                `${p.projectName},${state.users.find(u => u.id === p.qaId)?.name || 'Unassigned'},${p.projectType},${p.currentPhase},${p.status},${p.totalBugs || 0},${p.approvedForLive || 'No'}`
            ).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `QA_Report_${monthFilter}_${qaName}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            logActivity(`Exported QA report for ${monthFilter} - ${qaName}`);
        }

        function renderActivityLog() {
            const list = document.getElementById('activity-log-list');
            list.innerHTML = '';
            state.activityLog.forEach(log => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `<span>${new Date(log.timestamp).toLocaleString()} - ${log.user}: ${log.action}</span>`;
                list.appendChild(item);
            });
        }

        function showUserForm(userId = null) {
            if (state.currentUser.role !== 'Admin') {
                showNotification('Only Admins can manage users', 3000, true);
                return;
            }
            const user = userId ? state.users.find(u => u.id === userId) : null;
            const content = `
                <form id="user-form">
                    <div class="form-group">
                        <label for="user-name" class="required">Name</label>
                        <input type="text" id="user-name" value="${user ? user.name : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="user-email" class="required">Email</label>
                        <input type="email" id="user-email" value="${user ? user.email : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="user-password" class="required">Password</label>
                        <input type="password" id="user-password" value="${user ? user.password : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="user-role" class="required">Role</label>
                        <select id="user-role" required>
                            <option value="Admin" ${user && user.role === 'Admin' ? 'selected' : ''}>Admin</option>
                            <option value="Team Lead" ${user && user.role === 'Team Lead' ? 'selected' : ''}>Team Lead</option>
                            <option value="QA Member" ${user && user.role === 'QA Member' ? 'selected' : ''}>QA Member</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary">${user ? 'Update' : 'Add'} User</button>
                </form>
            `;
            showModal(`${user ? 'Edit' : 'Add'} User`, content);
            document.getElementById('user-form').onsubmit = (e) => {
                e.preventDefault();
                const name = document.getElementById('user-name').value.trim();
                const email = document.getElementById('user-email').value.trim();
                const password = document.getElementById('user-password').value;
                const role = document.getElementById('user-role').value;
                if (!name || !email || !password || !role) {
                    showNotification('All fields are required', 3000, true);
                    return;
                }
                if (state.users.some(u => u.email === email && (!user || u.id !== userId))) {
                    showNotification('Email already exists', 3000, true);
                    return;
                }
                if (user) {
                    const index = state.users.findIndex(u => u.id === userId);
                    state.users[index] = { ...user, name, email, password, role };
                    logActivity(`Updated user: ${name}`);
                } else {
                    state.users.push({
                        id: Date.now().toString(),
                        name,
                        email,
                        password,
                        role
                    });
                    logActivity(`Added user: ${name}`);
                }
                saveState('users', state.users);
                closeModal();
                showNotification('User saved successfully');
                renderUsers();
                setupSidebar();
            };
        }

        function renderUsers() {
            const list = document.getElementById('users-list');
            list.innerHTML = '';
            state.users.forEach(user => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <span>${user.name} (${user.email}) - ${user.role}</span>
                    ${state.currentUser.role === 'Admin' && user.id !== state.currentUser.id ? `
                        <div>
                            <button class="btn-primary" onclick="showUserForm('${user.id}')">Edit</button>
                            <button class="btn-danger" onclick="deleteUser('${user.id}')">Delete</button>
                        </div>
                    ` : ''}
                `;
                list.appendChild(item);
            });
        }

        function deleteUser(userId) {
            if (state.currentUser.role !== 'Admin') {
                showNotification('Only Admins can delete users', 3000, true);
                return;
            }
            if (userId === state.currentUser.id) {
                showNotification('You cannot delete yourself', 3000, true);
                return;
            }
            const user = state.users.find(u => u.id === userId);
            state.users = state.users.filter(u => u.id !== userId);
            state.tasks = state.tasks.map(t => t.assignee === userId ? { ...t, assignee: '' } : t);
            state.projectOverview = state.projectOverview.map(p => p.qaId === userId ? { ...p, qaId: '' } : p);
            logActivity(`Deleted user: ${user.name}`);
            saveState('users', state.users);
            saveState('tasks', state.tasks);
            saveState('projectOverview', state.projectOverview);
            showNotification('User deleted successfully');
            renderUsers();
            renderTasks();
            filterProjects();
        }

        function renderAssignRoles() {
            const list = document.getElementById('roles-list');
            list.innerHTML = '';
            state.users.forEach(user => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <span>${user.name} (${user.email})</span>
                    ${state.currentUser.role === 'Admin' ? `
                        <select onchange="updateRole('${user.id}', this.value)">
                            <option value="Admin" ${user.role === 'Admin' ? 'selected' : ''}>Admin</option>
                            <option value="Team Lead" ${user.role === 'Team Lead' ? 'selected' : ''}>Team Lead</option>
                            <option value="QA Member" ${user.role === 'QA Member' ? 'selected' : ''}>QA Member</option>
                        </select>
                    ` : `<span>${user.role}</span>`}
                `;
                list.appendChild(item);
            });
        }

        function updateRole(userId, role) {
            if (state.currentUser.role !== 'Admin') {
                showNotification('Only Admins can assign roles', 3000, true);
                return;
            }
            const index = state.users.findIndex(u => u.id === userId);
            const user = state.users[index];
            state.users[index].role = role;
            logActivity(`Updated role of ${user.name} to ${role}`);
            saveState('users', state.users);
            showNotification('Role updated successfully');
            renderAssignRoles();
            setupSidebar();
        }

        function renderProjects() {
            const list = document.getElementById('projects-list');
            list.innerHTML = '';
            state.projects.forEach(project => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <span>${project.name} (${project.category} - ${project.subcategory}) <a href="${project.link}" target="_blank">Link</a></span>
                    ${(state.currentUser.role === 'Admin' || state.currentUser.role === 'Team Lead') ? `
                        <div>
                            <button class="btn-primary" onclick="showProjectForm('${project.id}')">Edit</button>
                            <button class="btn-danger" onclick="deleteProject('${project.id}')">Delete</button>
                        </div>
                    ` : ''}
                `;
                list.appendChild(item);
            });
        }

        function updateProfile(e) {
            e.preventDefault();
            const name = document.getElementById('profile-name').value.trim();
            const email = document.getElementById('profile-email').value.trim();
            const password = document.getElementById('profile-password').value;
            if (!name || !email) {
                showNotification('Name and email are required', 3000, true);
                return;
            }
            if (state.users.some(u => u.email === email && u.id !== state.currentUser.id)) {
                showNotification('Email already exists', 3000, true);
                return;
            }
            const index = state.users.findIndex(u => u.id === state.currentUser.id);
            state.users[index] = {
                ...state.users[index],
                name,
                email,
                password: password || state.users[index].password
            };
            state.currentUser = state.users[index];
            saveState('users', state.users);
            saveState('currentUser', state.currentUser);
            logActivity('Updated profile');
            showNotification('Profile updated successfully');
            updateUserAvatar();
            document.getElementById('welcome-user').textContent = name;
            renderAll();
        }

        function calculateDashboardStats() {
            const stats = {
                'My Stats': { projects: 0, pendingApprovals: 0, completedProjects: 0 }
            };
            if (state.currentUser.role === 'Team Lead' || state.currentUser.role === 'Admin') {
                stats['Team Stats'] = { projects: 0, pendingApprovals: 0, completedProjects: 0 };
            }

            state.projectOverview.forEach(project => {
                if (project.qaId === state.currentUser.id || state.currentUser.role !== 'QA Member') {
                    stats['My Stats'].projects++;
                    if (project.tlApproval === 'Awaiting Approval') stats['My Stats'].pendingApprovals++;
                }
                if (stats['Team Stats']) {
                    stats['Team Stats'].projects++;
                    if (project.tlApproval === 'Awaiting Approval') stats['Team Stats'].pendingApprovals++;
                }
            });

            state.approvedProjects.forEach(project => {
                if (project.qaId === state.currentUser.id || state.currentUser.role !== 'QA Member') {
                    stats['My Stats'].completedProjects++;
                }
                if (stats['Team Stats']) {
                    stats['Team Stats'].completedProjects++;
                }
            });

            return stats;
        }

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('collapsed');
        }
    </script>
</body>
</html>
