<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA Team Dashboard</title>
    <link rel="icon" type="image/png" href="images/fav.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700;900&family=Work+Sans:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #fbd003; /* Yellow */
            --secondary: #929294; /* Gray */
            --dark-bg: #1a1a1a;
            --dark-card: #2a2a2a;
            --dark-hover: #3a3a3a;
            --text: #ffffff;
            --light-bg: #f4f4f4;
            --light-card: #ffffff;
            --light-hover: #e0e0e0;
            --light-text: #333333;
            --border-color: #444;
            --light-border: #ddd;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Work Sans", "Noto Sans", sans-serif;
            background: var(--dark-bg);
            color: var(--text);
            transition: all 0.3s ease;
            line-height: 1.6;
        }

        body.light-theme {
            background: var(--light-bg);
            color: var(--light-text);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Page Styles */
        #login-page {
            display: flex;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
        }

        #login-page .login-container {
            background-color: var(--dark-card);
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
        }

        body.light-theme #login-page .login-container {
            background-color: var(--light-card);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #login-page h2 {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        #login-page .form-group {
            margin-bottom: 1rem;
        }

        #login-page label {
            display: block;
            font-size: 0.875rem;
            font-weight: medium;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        body.light-theme #login-page label {
            color: var(--light-text);
        }

        #login-page input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--dark-hover);
            color: var(--text);
            font-size: 0.875rem;
        }

        body.light-theme #login-page input {
            background-color: var(--light-card);
            color: var(--light-text);
            border-color: var(--light-border);
        }

        #login-page input::placeholder {
            color: var(--secondary);
        }

        #login-page button {
            width: 100%;
            padding: 0.5rem;
            background-color: var(--primary);
            color: #000000;
            border: none;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: medium;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        #login-page button:hover {
            background-color: #e5bd00;
            transform: scale(1.02);
        }

        /* Header Styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--dark-card);
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        body.light-theme header {
            background: var(--light-card);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .logo img {
            height: 40px;
            vertical-align: middle;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info select, .user-info button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--primary);
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .nav-link {
            padding: 10px 20px;
            background: var(--dark-card);
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: background 0.3s, color 0.3s;
            white-space: nowrap;
            font-size: 16px;
        }

        body.light-theme .nav-link {
            background: var(--light-card);
        }

        .nav-link:hover {
            background: var(--dark-hover);
            color: var(--primary);
        }

        body.light-theme .nav-link:hover {
            background: var(--light-hover);
            color: var(--primary);
        }

        .nav-link.active {
            background: var(--primary);
            color: #000000;
        }

        /* Tab Panes */
        .tab-pane {
            display: none;
            background: var(--dark-card);
            padding: 20px;
            border-radius: 8px;
            transition: opacity 0.3s ease;
        }

        body.light-theme .tab-pane {
            background: var(--light-card);
        }

        .tab-pane.active {
            display: block;
            opacity: 1;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: var(--dark-card);
        }

        body.light-theme table {
            background: var(--light-card);
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        body.light-theme th, body.light-theme td {
            border-bottom: 1px solid var(--light-border);
        }

        th {
            background: var(--dark-hover);
            color: var(--primary);
            cursor: pointer;
            font-weight: bold;
        }

        body.light-theme th {
            background: var(--light-hover);
            color: var(--primary);
        }

        th:hover {
            background: var(--primary);
            color: #000000;
        }

        .editable:hover {
            background: var(--dark-hover);
            cursor: pointer;
        }

        body.light-theme .editable:hover {
            background: var(--light-hover);
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--dark-hover);
            color: var(--text);
            font-size: 14px;
        }

        body.light-theme input, body.light-theme select, body.light-theme textarea {
            background: var(--light-card);
            color: var(--light-text);
            border-color: var(--light-border);
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s, transform 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: #000000;
        }

        .btn-primary:hover {
            background: #e5bd00;
            transform: scale(1.02);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--dark-card);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--secondary);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body.light-theme .modal-content {
            background: var(--light-card);
        }

        .modal-content h2 {
            margin-bottom: 15px;
            font-size: 20px;
            color: var(--primary);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Notification */
        .notification {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: #000000;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .team-lead-only {
            display: none;
        }

        .alert-due {
            background: #e24a4a;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-block;
        }

        .btn-approved {
            background: #4a90e2;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .user-info {
                flex-direction: column;
                gap: 10px;
            }

            .nav-tabs {
                flex-direction: column;
                align-items: flex-start;
            }

            .nav-link {
                width: 100%;
                text-align: left;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 8px;
            }

            .modal-content {
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="login-page">
        <div class="login-container">
            <h2>QA Team Dashboard</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="username">Email</label>
                    <input type="email" id="username" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Password" required>
                </div>
                <button type="submit">Login</button>
            </form>
            <p style="text-align: center; margin-top: 1rem;">
                <a href="#" id="forgot-password-link" style="color: var(--primary); text-decoration: none;">Forgot Password?</a>
            </p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="container hidden">
        <header>
            <div class="logo">
                <img src="images/logo.png" alt="Logo">
            </div>
            <div class="user-info">
                <span id="user-name"></span>
                <select id="theme-toggle">
                    <option value="dark">Dark</option>
                    <option value="light">Light</option>
                </select>
                <button class="btn-primary py-1 px-3" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="nav-tabs">
            <div class="nav-link active" href="#daily-standup">Daily Standup</div>
            <div class="nav-link" href="#project-management">Project Management</div>
            <div class="nav-link" href="#approved-projects">Approved Projects</div>
            <div class="nav-link" href="#rejected-projects">Rejected Projects</div>
            <div class="nav-link" href="#activity-log">Activity Log</div>
            <div class="nav-link" href="#profile">Profile</div>
            <div class="nav-link team-lead-only" href="#user-management">User Management</div>
        </div>

        <div id="daily-standup" class="tab-pane active">
            <h2 class="text-2xl font-bold mb-4">Daily Standup</h2>
            <table>
                <thead>
                    <tr>
                        <th>Task Name</th>
                        <th>Project</th>
                        <th>Assigned Date</th>
                        <th>Due Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="standup-tasks-table"></tbody>
            </table>
            <div class="team-lead-only">
                <h3 class="text-xl font-semibold mb-4">Assign Task</h3>
                <form id="assign-task-form" class="space-y-4">
                    <div class="form-group">
                        <label for="assign-project" class="block text-sm font-medium mb-2">Project</label>
                        <select id="assign-project" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required></select>
                    </div>
                    <div class="form-group">
                        <label for="assign-qa" class="block text-sm font-medium mb-2">QA</label>
                        <select id="assign-qa" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required></select>
                    </div>
                    <div class="form-group">
                        <label for="project-phase" class="block text-sm font-medium mb-2">Phase</label>
                        <select id="project-phase" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required>
                            <option value="Unit Testing">Unit Testing</option>
                            <option value="Integration Testing">Integration Testing</option>
                            <option value="System Testing">System Testing</option>
                            <option value="Regression Testing">Regression Testing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="task-name" class="block text-sm font-medium mb-2">Task Name</label>
                        <input type="text" id="task-name" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required>
                    </div>
                    <div class="form-group">
                        <label for="due-date" class="block text-sm font-medium mb-2">Due Date</label>
                        <input type="date" id="due-date" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required>
                    </div>
                    <button type="submit" class="btn-primary py-2 px-4 rounded">Assign Task</button>
                </form>
            </div>
        </div>

        <div id="project-management" class="tab-pane">
            <h2 class="text-2xl font-bold mb-4">Project Management</h2>
            <div class="team-lead-only mb-4">
                <button class="btn-primary py-2 px-4 rounded" onclick="openModal('create-project-modal')">Create Project</button>
            </div>
            <input type="text" id="project-search" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white mb-4" placeholder="Search projects...">
            <table>
                <thead>
                    <tr>
                        <th onclick="sortTable('projects-table', 0)">Project Name</th>
                        <th onclick="sortTable('projects-table', 1)">Category</th>
                        <th onclick="sortTable('projects-table', 2)">Type</th>
                        <th onclick="sortTable('projects-table', 3)">Phase</th>
                        <th onclick="sortTable('projects-table', 4)">KT</th>
                        <th onclick="sortTable('projects-table', 5)">Start Date</th>
                        <th onclick="sortTable('projects-table', 6)">End Date</th>
                        <th onclick="sortTable('projects-table', 7)">Status</th>
                        <th onclick="sortTable('projects-table', 8)">Total Bugs</th>
                        <th onclick="sortTable('projects-table', 9)">HTML Bugs</th>
                        <th onclick="sortTable('projects-table', 10)">Functional Bugs</th>
                        <th onclick="sortTable('projects-table', 11)">Assigned QA</th>
                        <th>Bug Tracker</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="projects-table"></tbody>
            </table>
            <div class="team-lead-only">
                <h3 class="text-xl font-semibold mb-4">Export Report</h3>
                <form class="space-y-4">
                    <div class="form-group">
                        <label for="report-type" class="block text-sm font-medium mb-2">Report Type</label>
                        <select id="report-type" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white">
                            <option value="monthly">Monthly Report</option>
                            <option value="rejected">Rejected Projects</option>
                            <option value="qa-wise">QA-wise Report</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="report-month" class="block text-sm font-medium mb-2">Month</label>
                        <input type="month" id="report-month" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white">
                    </div>
                    <div class="form-group">
                        <label for="report-qa" class="block text-sm font-medium mb-2">QA</label>
                        <select id="report-qa" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white"></select>
                    </div>
                    <div class="form-group">
                        <label for="report-project" class="block text-sm font-medium mb-2">Project Filter</label>
                        <input type="text" id="report-project" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" placeholder="Filter by project name">
                    </div>
                    <button type="button" class="btn-primary py-2 px-4 rounded" onclick="exportReport()">Export Report</button>
                </form>
            </div>
        </div>

        <div id="approved-projects" class="tab-pane">
            <h2 class="text-2xl font-bold mb-4">Approved Projects</h2>
            <input type="text" id="approved-search" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white mb-4" placeholder="Search approved projects...">
            <table>
                <thead>
                    <tr>
                        <th onclick="sortTable('approved-table', 0)">Project Name</th>
                        <th onclick="sortTable('approved-table', 1)">QA</th>
                        <th onclick="sortTable('approved-table', 2)">Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="approved-table"></tbody>
            </table>
        </div>

        <div id="rejected-projects" class="tab-pane">
            <h2 class="text-2xl font-bold mb-4">Rejected Projects</h2>
            <input type="text" id="rejected-search" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white mb-4" placeholder="Search rejected projects...">
            <table>
                <thead>
                    <tr>
                        <th onclick="sortTable('rejected-table', 0)">Project Name</th>
                        <th onclick="sortTable('rejected-table', 1)">QA</th>
                        <th onclick="sortTable('rejected-table', 2)">Date</th>
                        <th onclick="sortTable('rejected-table', 3)">Phase</th>
                        <th onclick="sortTable('rejected-table', 4)">PC</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody id="rejected-table"></tbody>
            </table>
        </div>

        <div id="activity-log" class="tab-pane">
            <h2 class="text-2xl font-bold mb-4">Activity Log</h2>
            <input type="text" id="activity-search" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white mb-4" placeholder="Search activity log...">
            <table>
                <thead>
                    <tr>
                        <th onclick="sortTable('activity-table', 0)">Project</th>
                        <th onclick="sortTable('activity-table', 1)">QA</th>
                        <th onclick="sortTable('activity-table', 2)">Type</th>
                        <th onclick="sortTable('activity-table', 3)">Details</th>
                        <th onclick="sortTable('activity-table', 4)">Timestamp</th>
                    </tr>
                </thead>
                <tbody id="activity-table"></tbody>
            </table>
        </div>

        <div id="profile" class="tab-pane">
            <h2 class="text-2xl font-bold mb-4">Profile</h2>
            <form id="profile-form" class="space-y-4">
                <div class="form-group">
                    <label for="profile-username" class="block text-sm font-medium mb-2">Username</label>
                    <input type="text" id="profile-username" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" readonly>
                </div>
                <div class="form-group">
                    <label for="profile-role" class="block text-sm font-medium mb-2">Role</label>
                    <input type="text" id="profile-role" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" readonly>
                </div>
                <div class="form-group">
                    <label for="profile-email" class="block text-sm font-medium mb-2">Email</label>
                    <input type="email" id="profile-email" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white">
                </div>
                <div class="form-group">
                    <label for="change-password" class="block text-sm font-medium mb-2">Change Password</label>
                    <input type="password" id="change-password" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" placeholder="New password">
                </div>
                <button type="submit" class="btn-primary py-2 px-4 rounded">Update Profile</button>
            </form>
        </div>

        <div id="user-management" class="tab-pane team-lead-only">
            <h2 class="text-2xl font-bold mb-4">User Management</h2>
            <form id="add-user-form" class="space-y-4 mb-4">
                <div class="form-group">
                    <label for="new-username" class="block text-sm font-medium mb-2">Email</label>
                    <input type="email" id="new-username" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" placeholder="e.g., newuser@intersmart.in" required>
                </div>
                <div class="form-group">
                    <label for="new-password" class="block text-sm font-medium mb-2">Password</label>
                    <input type="password" id="new-password" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required>
                </div>
                <div class="form-group">
                    <label for="new-name" class="block text-sm font-medium mb-2">Name</label>
                    <input type="text" id="new-name" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required>
                </div>
                <div class="form-group">
                    <label for="new-role" class="block text-sm font-medium mb-2">Role</label>
                    <select id="new-role" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required>
                        <option value="Team Lead">Team Lead</option>
                        <option value="QA Member">QA Member</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary py-2 px-4 rounded">Add User</button>
            </form>
            <table>
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Name</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table"></tbody>
            </table>
        </div>

        <div id="create-project-modal" class="modal">
            <div class="modal-content">
                <h2>Create Project</h2>
                <form id="create-project-form" class="space-y-4">
                    <div class="form-group">
                        <label for="project-name" class="block text-sm font-medium mb-2">Project Name</label>
                        <input type="text" id="project-name" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required>
                    </div>
                    <div class="form-group">
                        <label for="project-category" class="block text-sm font-medium mb-2">Category</label>
                        <select id="project-category" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required>
                            <option value="Web">Web</option>
                            <option value="Mobile">Mobile</option>
                            <option value="API">API</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="project-type" class="block text-sm font-medium mb-2">Type</label>
                        <select id="project-type" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required>
                            <option value="Internal">Internal</option>
                            <option value="External">External</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="project-phase" class="block text-sm font-medium mb-2">Phase</label>
                        <select id="project-phase" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required>
                            <option value="Unit Testing">Unit Testing</option>
                            <option value="Integration Testing">Integration Testing</option>
                            <option value="System Testing">System Testing</option>
                            <option value="Regression Testing">Regression Testing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bug-tracker" class="block text-sm font-medium mb-2">Bug Tracker URL</label>
                        <input type="url" id="bug-tracker" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white">
                    </div>
                    <div class="form-group">
                        <label for="start-date" class="block text-sm font-medium mb-2">Start Date</label>
                        <input type="date" id="start-date" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required>
                    </div>
                    <div class="form-group">
                        <label for="end-date" class="block text-sm font-medium mb-2">End Date</label>
                        <input type="date" id="end-date" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required>
                    </div>
                    <div class="modal-actions">
                        <button type="button" onclick="closeModal('create-project-modal')" class="p-2 bg-[var(--dark-hover)] text-white rounded">Cancel</button>
                        <button type="submit" class="btn-primary py-2 px-4 rounded">Create Project</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="edit-project-modal" class="modal">
            <div class="modal-content">
                <h2>Edit Project</h2>
                <form id="edit-project-form" class="space-y-4">
                    <input type="hidden" id="edit-project-id">
                    <div class="form-group">
                        <label for="edit-project-name" class="block text-sm font-medium mb-2">Project Name</label>
                        <input type="text" id="edit-project-name" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-project-category" class="block text-sm font-medium mb-2">Category</label>
                        <select id="edit-project-category" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required>
                            <option value="Web">Web</option>
                            <option value="Mobile">Mobile</option>
                            <option value="API">API</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-project-type" class="block text-sm font-medium mb-2">Type</label>
                        <select id="edit-project-type" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required>
                            <option value="Internal">Internal</option>
                            <option value="External">External</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-project-phase" class="block text-sm font-medium mb-2">Phase</label>
                        <select id="edit-project-phase" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required>
                            <option value="Unit Testing">Unit Testing</option>
                            <option value="Integration Testing">Integration Testing</option>
                            <option value="System Testing">System Testing</option>
                            <option value="Regression Testing">Regression Testing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-project-kt" class="block text-sm font-medium mb-2">KT</label>
                        <select id="edit-project-kt" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-project-start" class="block text-sm font-medium mb-2">Start Date</label>
                        <input type="date" id="edit-project-start" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-project-end" class="block text-sm font-medium mb-2">End Date</label>
                        <input type="date" id="edit-project-end" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-project-bug-tracker" class="block text-sm font-medium mb-2">Bug Tracker URL</label>
                        <input type="url" id="edit-project-bug-tracker" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white">
                    </div>
                    <div class="form-group">
                        <label for="edit-project-qa" class="block text-sm font-medium mb-2">Assigned QA</label>
                        <select id="edit-project-qa" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white"></select>
                    </div>
                    <div class="modal-actions">
                        <button type="button" onclick="closeModal('edit-project-modal')" class="p-2 bg-[var(--dark-hover)] text-white rounded">Cancel</button>
                        <button type="submit" class="btn-primary py-2 px-4 rounded">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="report-bug-modal" class="modal">
            <div class="modal-content">
                <h2>Report Bug</h2>
                <form id="report-bug-form" class="space-y-4">
                    <input type="hidden" id="bug-project-id">
                    <div class="form-group">
                        <label for="bug-type" class="block text-sm font-medium mb-2">Bug Type</label>
                        <select id="bug-type" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required>
                            <option value="HTML">HTML</option>
                            <option value="Functional">Functional</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bug-description" class="block text-sm font-medium mb-2">Description</label>
                        <textarea id="bug-description" class="w-full p-2 border rounded bg-[var(--dark-hover)] text-white" required aria-label="Bug Description"></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" onclick="closeModal('report-bug-modal')" class="p-2 bg-[var(--dark-hover)] text-white rounded" aria-label="Cancel">Cancel</button>
                        <button type="submit" class="btn-primary py-2 px-4 rounded" aria-label="Report Bug">Report Bug</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="notification" class="notification"></div>
    </div>

    <!-- Papa Parse for CSV Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBq2gKRE6O5v2LB1bGmj6z4VyH_sc6WsVA",
            authDomain: "qa-team-dashboard-62687.firebaseapp.com",
            projectId: "qa-team-dashboard-62687",
            storageBucket: "qa-team-dashboard-62687.firebasestorage.app",
            messagingSenderId: "245214914125",
            appId: "1:245214914125:web:b36a6cdecc1c29a8e31e04",
            measurementId: "G-19K1YSBXH0"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;

        // Load Theme on Page Load
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.classList.toggle('light-theme', savedTheme === 'light');
            document.getElementById('theme-toggle').value = savedTheme;
            populateQADropdowns();
            renderUsersTable();

            // Activate the first tab by default
            document.querySelector('.nav-link').classList.add('active');
        });

        // Login Handler with Enhanced Debugging
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            console.log('Attempting login with:', { username, password });

            auth.signInWithEmailAndPassword(username, password)
                .then(async (userCredential) => {
                    console.log('Firebase Authentication successful:', userCredential.user.email);
                    const userId = username.split('@')[0];
                    console.log('Fetching user data from Firestore for ID:', userId);

                    const userDoc = await db.collection('users').doc(userId).get();
                    if (!userDoc.exists) {
                        console.error('User data not found in Firestore for ID:', userId);
                        showNotification('User data not found in database. Please contact your admin to add your user profile.');
                        auth.signOut();
                        return;
                    }

                    console.log('User data found in Firestore:', userDoc.data());
                    currentUser = { username, ...userDoc.data() };
                    console.log('Current user set:', currentUser);

                    document.getElementById('login-page').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    document.getElementById('user-name').textContent = currentUser.name;

                    if (currentUser.role === 'Team Lead') {
                        document.querySelectorAll('.team-lead-only').forEach(el => el.classList.remove('hidden'));
                    }

                    loadDashboardData();
                })
                .catch((error) => {
                    console.error('Login error:', error.code, error.message);
                    if (error.code === 'auth/wrong-password') {
                        showNotification('Incorrect password. Please try again or use "Forgot Password".');
                    } else if (error.code === 'auth/user-not-found') {
                        showNotification('User not found. Please check your email or contact your admin.');
                    } else if (error.code === 'auth/invalid-email') {
                        showNotification('Invalid email format. Please enter a valid email address.');
                    } else {
                        showNotification('Login failed: ' + error.message);
                    }
                });
        });

        // Forgot Password Handler
        document.getElementById('forgot-password-link').addEventListener('click', (e) => {
            e.preventDefault();
            const email = prompt('Please enter your email address to reset your password:');
            if (email) {
                auth.sendPasswordResetEmail(email)
                    .then(() => {
                        showNotification('Password reset email sent! Check your inbox (and spam/junk folder).');
                    })
                    .catch((error) => {
                        console.error('Password reset error:', error.code, error.message);
                        if (error.code === 'auth/user-not-found') {
                            showNotification('No user found with this email. Please check your email or contact your admin.');
                        } else if (error.code === 'auth/invalid-email') {
                            showNotification('Invalid email format. Please enter a valid email address.');
                        } else {
                            showNotification('Error sending password reset email: ' + error.message);
                        }
                    });
            }
        });

        // Logout Handler
        function logout() {
            auth.signOut().then(() => {
                currentUser = null;
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('login-page').classList.remove('hidden');
            }).catch((error) => {
                showNotification('Logout failed: ' + error.message);
            });
        }

        // Tab Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                document.querySelectorAll('.tab-pane').forEach(tab => tab.classList.remove('active'));
                const targetTab = document.getElementById(link.getAttribute('href').substring(1));
                targetTab.classList.add('active');
                targetTab.style.opacity = 0;
                setTimeout(() => targetTab.style.opacity = 1, 10);
            });
            link.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') link.click();
            });
        });

        // Notifications
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => notification.style.display = 'none', 5000); // Increased to 5 seconds for better visibility
        }

        // Modal Handling
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
            modal.querySelector('input, select, textarea').focus();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Load Dashboard Data
        async function loadDashboardData() {
            try {
                const tasksSnap = await db.collection('tasks').where('assignee', '==', currentUser.username).get();
                const tasks = tasksSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const projectsSnap = await db.collection('projects').get();
                const projects = projectsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const approvedSnap = await db.collection('approvedProjects').get();
                const approvedProjects = approvedSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const rejectedSnap = await db.collection('rejectedProjects').get();
                const rejectedProjects = rejectedSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const activitySnap = await db.collection('activityLog').get();
                const activityLog = activitySnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderStandupTasksTable(tasks);
                renderProjectsTable(projects);
                renderApprovedTable(approvedProjects);
                renderRejectedTable(rejectedProjects);
                renderActivityTable(activityLog);
                renderProfile();
                populateProjectDropdown(projects);
                renderUsersTable();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showNotification('Failed to load dashboard data: ' + error.message);
            }
        }

        // Render Daily Standup Form as a Table
        function renderStandupTasksTable(tasks) {
            const table = document.getElementById('standup-tasks-table');
            table.innerHTML = tasks
                .filter(t => t.assignee === currentUser.username)
                .map(t => {
                    const dueDate = new Date(t.dueDate);
                    const today = new Date();
                    const isDueSoon = dueDate - today < 24 * 60 * 60 * 1000 && dueDate > today;
                    return `
                        <tr>
                            <td>${t.name || 'N/A'}</td>
                            <td>${t.projectName || 'N/A'}</td>
                            <td>${t.assignedDate || 'N/A'}</td>
                            <td>${t.dueDate || 'N/A'} ${isDueSoon ? '<span class="alert-due">Due Soon</span>' : ''}</td>
                            <td>${t.status === 'inprogress' ? 'In Progress' : 'Completed'}</td>
                            <td>
                                ${t.status === 'inprogress' ? `
                                    <button class="text-green-400 text-sm tooltip" onclick="markTaskCompleted('${t.id}')" aria-label="Mark task as completed">
                                        Mark as Completed
                                        <span class="tooltiptext">Mark this task as completed</span>
                                    </button>
                                ` : ''}
                                ${currentUser.role === 'Team Lead' ? `
                                    <button class="text-red-400 text-sm ml-2 tooltip" onclick="deleteTask('${t.id}')" aria-label="Delete task">
                                        Delete
                                        <span class="tooltiptext">Delete this task</span>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');
        }

        // Mark Task as Completed
        async function markTaskCompleted(taskId) {
            try {
                await db.collection('tasks').doc(taskId).update({ status: 'completed' });
                const taskSnap = await db.collection('tasks').doc(taskId).get();
                const task = taskSnap.data();
                logActivity(task.projectId, currentUser.username, 'Task Completed', `Marked "${task.name}" as completed`);
                loadDashboardData();
                showNotification(`Task "${task.name}" marked as completed`);
            } catch (error) {
                showNotification('Failed to mark task as completed: ' + error.message);
            }
        }

        // Delete Task
        async function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                try {
                    await db.collection('tasks').doc(taskId).delete();
                    loadDashboardData();
                    showNotification('Task deleted successfully');
                } catch (error) {
                    showNotification('Failed to delete task: ' + error.message);
                }
            }
        }

        // Assign Task
        document.getElementById('assign-task-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (currentUser.role !== 'Team Lead') return;
            const projectId = document.getElementById('assign-project').value;
            const qa = document.getElementById('assign-qa').value;
            const phase = document.getElementById('project-phase').value;
            const taskName = document.getElementById('task-name').value;
            const dueDate = document.getElementById('due-date').value;

            try {
                const projectSnap = await db.collection('projects').doc(projectId).get();
                const project = projectSnap.data();
                if (project) {
                    const newTask = {
                        projectId: projectId,
                        projectName: project.name,
                        name: taskName,
                        assignee: qa,
                        assignedDate: new Date().toISOString().split('T')[0],
                        dueDate: dueDate,
                        status: 'inprogress',
                        alertSent: false
                    };
                    await db.collection('tasks').add(newTask);
                    await db.collection('projects').doc(projectId).update({ assignedQA: qa, phase });
                    logActivity(projectId, qa, 'Task Assigned', `Assigned "${taskName}" to ${qa}`);
                    loadDashboardData();
                    showNotification(`Task "${taskName}" assigned to ${qa}`);
                    e.target.reset();
                } else {
                    showNotification('Project not found');
                }
            } catch (error) {
                showNotification('Failed to assign task: ' + error.message);
            }
        });

        // Projects Table
        async function renderProjectsTable(projects) {
            try {
                const table = document.getElementById('projects-table');
                const usersSnap = await db.collection('users').get();
                const users = Object.fromEntries(usersSnap.docs.map(doc => [doc.id, doc.data()]));
                table.innerHTML = projects.map(p => `
                    <tr>
                        <td class="editable" onclick="editProject('${p.id}')">${p.name || 'N/A'}</td>
                        <td>${p.category || 'N/A'}</td>
                        <td>${p.type || 'N/A'}</td>
                        <td>${p.phase || 'N/A'}</td>
                        <td>${p.kt || 'N/A'}</td>
                        <td>${p.start || 'N/A'}</td>
                        <td>${p.end || 'N/A'}</td>
                        <td>${p.status || 'N/A'}</td>
                        <td>${p.bugs || 0}</td>
                        <td>${p.htmlBugs || 0}</td>
                        <td>${p.funcBugs || 0}</td>
                        <td>${users[p.assignedQA]?.name || 'Not Assigned'}</td>
                        <td><a href="${p.bugTracker || '#'}" target="_blank" aria-label="View Bug Tracker">${p.bugTracker ? 'View' : 'N/A'}</a></td>
                        <td>
                            <button class="text-blue-400 text-sm mr-2 tooltip" onclick="openReportBugModal('${p.id}')" aria-label="Report a bug">
                                Report Bug
                                <span class="tooltiptext">Report a bug for this project</span>
                            </button>
                            ${currentUser.role === 'Team Lead' ? `
                                <button class="text-green-400 text-sm mr-2 tooltip" onclick="approveProject('${p.id}')" aria-label="Approve project">
                                    Approve
                                    <span class="tooltiptext">Approve this project</span>
                                </button>
                                <button class="text-red-400 text-sm mr-2 tooltip" onclick="rejectProject('${p.id}')" aria-label="Reject project">
                                    Reject
                                    <span class="tooltiptext">Reject this project</span>
                                </button>
                                <button class="text-red-400 text-sm tooltip" onclick="deleteProject('${p.id}')" aria-label="Delete project">
                                    Delete
                                    <span class="tooltiptext">Delete this project</span>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showNotification('Failed to load projects table: ' + error.message);
            }
        }

        async function editProject(projectId) {
            if (currentUser.role !== 'Team Lead') return;
            try {
                const projectSnap = await db.collection('projects').doc(projectId).get();
                const project = projectSnap.data();
                if (project) {
                    document.getElementById('edit-project-id').value = projectId;
                    document.getElementById('edit-project-name').value = project.name;
                    document.getElementById('edit-project-category').value = project.category;
                    document.getElementById('edit-project-type').value = project.type;
                    document.getElementById('edit-project-phase').value = project.phase;
                    document.getElementById('edit-project-kt').value = project.kt;
                    document.getElementById('edit-project-start').value = project.start;
                    document.getElementById('edit-project-end').value = project.end;
                    document.getElementById('edit-project-bug-tracker').value = project.bugTracker;
                    document.getElementById('edit-project-qa').value = project.assignedQA || '';
                    openModal('edit-project-modal');
                }
            } catch (error) {
                showNotification('Failed to load project for editing: ' + error.message);
            }
        }

        document.getElementById('edit-project-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const projectId = document.getElementById('edit-project-id').value;
            try {
                await db.collection('projects').doc(projectId).update({
                    name: document.getElementById('edit-project-name').value,
                    category: document.getElementById('edit-project-category').value,
                    type: document.getElementById('edit-project-type').value,
                    phase: document.getElementById('edit-project-phase').value,
                    kt: document.getElementById('edit-project-kt').value,
                    start: document.getElementById('edit-project-start').value,
                    end: document.getElementById('edit-project-end').value,
                    bugTracker: document.getElementById('edit-project-bug-tracker').value,
                    assignedQA: document.getElementById('edit-project-qa').value
                });
                logActivity(projectId, currentUser.username, 'Project Updated', `Edited project details`);
                loadDashboardData();
                closeModal('edit-project-modal');
                showNotification('Project updated successfully');
            } catch (error) {
                showNotification('Failed to update project: ' + error.message);
            }
        });

        // Report Bug
        function openReportBugModal(projectId) {
            document.getElementById('bug-project-id').value = projectId;
            openModal('report-bug-modal');
        }

        document.getElementById('report-bug-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const projectId = document.getElementById('bug-project-id').value;
            const bugType = document.getElementById('bug-type').value;
            const description = document.getElementById('bug-description').value;

            try {
                const projectRef = db.collection('projects').doc(projectId);
                const projectSnap = await projectRef.get();
                const project = projectSnap.data();
                if (project) {
                    const updates = {
                        bugs: (project.bugs || 0) + 1,
                        status: 'Awaiting Fixes'
                    };
                    if (bugType === 'HTML') {
                        updates.htmlBugs = (project.htmlBugs || 0) + 1;
                    } else {
                        updates.funcBugs = (project.funcBugs || 0) + 1;
                    }
                    await projectRef.update(updates);
                    logActivity(projectId, currentUser.username, 'Bug Reported', `${bugType} bug: ${description}`);
                    loadDashboardData();
                    closeModal('report-bug-modal');
                    showNotification(`Bug reported for ${project.name}`);
                }
            } catch (error) {
                showNotification('Failed to report bug: ' + error.message);
            }
        });

        // Approve/Reject Project
        async function approveProject(projectId) {
            if (currentUser.role !== 'Team Lead') return;
            try {
                const projectSnap = await db.collection('projects').doc(projectId).get();
                const project = projectSnap.data();
                if (project) {
                    await db.collection('approvedProjects').add({
                        projectId,
                        name: project.name,
                        qa: project.assignedQA || 'Not Assigned',
                        date: new Date().toISOString().split('T')[0]
                    });
                    await db.collection('projects').doc(projectId).delete();
                    logActivity(projectId, currentUser.username, 'Project Approved', `Approved for live`);
                    loadDashboardData();
                    showNotification(`Project ${project.name} approved`);
                }
            } catch (error) {
                showNotification('Failed to approve project: ' + error.message);
            }
        }

        async function rejectProject(projectId) {
            if (currentUser.role !== 'Team Lead') return;
            try {
                const projectSnap = await db.collection('projects').doc(projectId).get();
                const project = projectSnap.data();
                if (project) {
                    const reason = prompt('Enter reason for rejection:');
                    if (reason) {
                        await db.collection('rejectedProjects').add({
                            projectId,
                            name: project.name,
                            qa: project.assignedQA || 'Not Assigned',
                            date: new Date().toISOString().split('T')[0],
                            phase: project.phase,
                            pc: 'Bindhu',
                            reason
                        });
                        await db.collection('projects').doc(projectId).delete();
                        logActivity(projectId, currentUser.username, 'Project Rejected', `Reason: ${reason}`);
                        loadDashboardData();
                        showNotification(`Project ${project.name} rejected`);
                    }
                }
            } catch (error) {
                showNotification('Failed to reject project: ' + error.message);
            }
        }

        async function deleteProject(projectId) {
            if (currentUser.role !== 'Team Lead') return;
            if (confirm('Are you sure you want to delete this project?')) {
                try {
                    await db.collection('projects').doc(projectId).delete();
                    logActivity(projectId, currentUser.username, 'Project Deleted', `Project removed`);
                    loadDashboardData();
                    showNotification('Project deleted successfully');
                } catch (error) {
                    showNotification('Failed to delete project: ' + error.message);
                }
            }
        }

        // Search Projects
        document.getElementById('project-search').addEventListener('input', async (e) => {
            const searchTerm = e.target.value.toLowerCase();
            try {
                const projectsSnap = await db.collection('projects').get();
                const projects = projectsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const usersSnap = await db.collection('users').get();
                const users = Object.fromEntries(usersSnap.docs.map(doc => [doc.id, doc.data()]));
                const filteredProjects = projects.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) ||
                    p.category.toLowerCase().includes(searchTerm) ||
                    p.type.toLowerCase().includes(searchTerm) ||
                    (p.assignedQA && users[p.assignedQA]?.name.toLowerCase().includes(searchTerm))
                );
                renderProjectsTable(filteredProjects);
            } catch (error) {
                showNotification('Failed to search projects: ' + error.message);
            }
        });

        // Approved Projects Table
        async function renderApprovedTable(approvedProjects) {
            try {
                const usersSnap = await db.collection('users').get();
                const users = Object.fromEntries(usersSnap.docs.map(doc => [doc.id, doc.data()]));
                const table = document.getElementById('approved-table');
                table.innerHTML = approvedProjects.map(p => `
                    <tr>
                        <td>${p.name || 'N/A'}</td>
                        <td>${users[p.qa]?.name || 'Not Assigned'}</td>
                        <td>${p.date || 'N/A'}</td>
                        <td><span class="btn-approved">APPROVED</span></td>
                    </tr>
                `).join('');
            } catch (error) {
                showNotification('Failed to render approved table: ' + error.message);
            }
        }

        document.getElementById('approved-search').addEventListener('input', async (e) => {
            const searchTerm = e.target.value.toLowerCase();
            try {
                const approvedSnap = await db.collection('approvedProjects').get();
                const approvedProjects = approvedSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const filteredProjects = approvedProjects.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) ||
                    (p.qa && users[p.qa]?.name.toLowerCase().includes(searchTerm))
                );
                renderApprovedTable(filteredProjects);
            } catch (error) {
                showNotification('Failed to search approved projects: ' + error.message);
            }
        });

        // Rejected Projects Table
        async function renderRejectedTable(rejectedProjects) {
            try {
                const usersSnap = await db.collection('users').get();
                const users = Object.fromEntries(usersSnap.docs.map(doc => [doc.id, doc.data()]));
                const table = document.getElementById('rejected-table');
                table.innerHTML = rejectedProjects.map(p => `
                    <tr>
                        <td>${p.name || 'N/A'}</td>
                        <td>${users[p.qa]?.name || 'Not Assigned'}</td>
                        <td>${p.date || 'N/A'}</td>
                        <td>${p.phase || 'N/A'}</td>
                        <td>${p.pc || 'N/A'}</td>
                        <td>${p.reason || 'N/A'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                showNotification('Failed to render rejected table: ' + error.message);
            }
        }

        document.getElementById('rejected-search').addEventListener('input', async (e) => {
            const searchTerm = e.target.value.toLowerCase();
            try {
                const rejectedSnap = await db.collection('rejectedProjects').get();
                const rejectedProjects = rejectedSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const filteredProjects = rejectedProjects.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) ||
                    (p.qa && users[p.qa]?.name.toLowerCase().includes(searchTerm)) ||
                    p.reason.toLowerCase().includes(searchTerm)
                );
                renderRejectedTable(filteredProjects);
            } catch (error) {
                showNotification('Failed to search rejected projects: ' + error.message);
            }
        });

        // Activity Log
        async function renderActivityTable(activityLog) {
            try {
                const projectsSnap = await db.collection('projects').get();
                const projects = projectsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const usersSnap = await db.collection('users').get();
                const users = Object.fromEntries(usersSnap.docs.map(doc => [doc.id, doc.data()]));

                const table = document.getElementById('activity-table');
                table.innerHTML = activityLog.map(a => `
                    <tr>
                        <td>${projects.find(p => p.id === a.projectId)?.name || 'N/A'}</td>
                        <td>${users[a.qa]?.name || 'Unknown'}</td>
                        <td>${a.type || 'N/A'}</td>
                        <td>${a.details || 'N/A'}</td>
                        <td>${new Date(a.timestamp).toLocaleString()}</td>
                    </tr>
                `).join('');
            } catch (error) {
                showNotification('Failed to render activity table: ' + error.message);
            }
        }

        document.getElementById('activity-search').addEventListener('input', async (e) => {
            const searchTerm = e.target.value.toLowerCase();
            try {
                const activitySnap = await db.collection('activityLog').get();
                const activityLog = activitySnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const filteredActivity = activityLog.filter(a => 
                    (projects.find(p => p.id === a.projectId)?.name.toLowerCase().includes(searchTerm)) ||
                    (users[a.qa]?.name.toLowerCase().includes(searchTerm)) ||
                    a.type.toLowerCase().includes(searchTerm) ||
                    a.details.toLowerCase().includes(searchTerm)
                );
                renderActivityTable(filteredActivity);
            } catch (error) {
                showNotification('Failed to search activity log: ' + error.message);
            }
        });

        async function logActivity(projectId, qa, type, details) {
            try {
                await db.collection('activityLog').add({
                    projectId,
                    qa,
                    type,
                    details,
                    timestamp: new Date().toISOString()
                });
            } catch (error) {
                console.error('Failed to log activity:', error);
            }
        }

        // Create Project
        document.getElementById('create-project-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (currentUser.role !== 'Team Lead') return;
            const projectName = document.getElementById('project-name').value;
            const projectCategory = document.getElementById('project-category').value;
            const projectType = document.getElementById('project-type').value;
            const projectPhase = document.getElementById('project-phase').value;
            const bugTracker = document.getElementById('bug-tracker').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            try {
                const docRef = await db.collection('projects').add({
                    name: projectName,
                    category: projectCategory,
                    type: projectType,
                    phase: projectPhase,
                    kt: 'No',
                    start: startDate,
                    end: endDate,
                    status: 'In Progress',
                    bugs: 0,
                    htmlBugs: 0,
                    funcBugs: 0,
                    assignedQA: '',
                    bugTracker
                });
                logActivity(docRef.id, currentUser.username, 'Project Created', `Created ${projectName}`);
                loadDashboardData();
                showNotification(`Project ${projectName} created successfully`);
                e.target.reset();
            } catch (error) {
                showNotification('Failed to create project: ' + error.message);
            }
        });

        // Populate Project Dropdown
        function populateProjectDropdown(projects) {
            const projectSelect = document.getElementById('assign-project');
            projectSelect.innerHTML = '<option value="">Select Project</option>' + 
                projects.map(project => `<option value="${project.id}">${project.name}</option>`).join('');
        }

        // Populate QA Dropdowns
        async function populateQADropdowns() {
            try {
                const usersSnap = await db.collection('users').get();
                const users = usersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const assignQA = document.getElementById('assign-qa');
                const reportQA = document.getElementById('report-qa');
                const editQA = document.getElementById('edit-project-qa');
                
                assignQA.innerHTML = '<option value="">Select QA</option>' + 
                    users.map(user => `<option value="${user.id}">${user.name} (${user.id})</option>`).join('');
                reportQA.innerHTML = '<option value="">All QA</option>' + 
                    users.map(user => `<option value="${user.id}">${user.name} (${user.id})</option>`).join('');
                editQA.innerHTML = '<option value="">Not Assigned</option>' + 
                    users.map(user => `<option value="${user.id}">${user.name} (${user.id})</option>`).join('');
            } catch (error) {
                showNotification('Failed to load QA dropdowns: ' + error.message);
            }
        }

        // User Management
        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (currentUser.role !== 'Team Lead') return;
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const name = document.getElementById('new-name').value;
            const role = document.getElementById('new-role').value;

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(username, password);
                const userId = username.split('@')[0];
                
                await db.collection('users').doc(userId).set({
                    name,
                    role
                });
                
                populateQADropdowns();
                renderUsersTable();
                showNotification(`User ${name} added successfully`);
                e.target.reset();
            } catch (error) {
                showNotification('Failed to add user: ' + error.message);
            }
        });

        async function renderUsersTable() {
            try {
                const usersSnap = await db.collection('users').get();
                const users = usersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const table = document.getElementById('users-table');
                table.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.name}</td>
                        <td>${user.role}</td>
                        <td>
                            ${currentUser.role === 'Team Lead' && user.id !== currentUser.username.split('@')[0] ? `
                                <button class="text-red-400 text-sm tooltip" onclick="deleteUser('${user.id}')" aria-label="Delete user">
                                    Delete
                                    <span class="tooltiptext">Delete this user</span>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showNotification('Failed to load users table: ' + error.message);
            }
        }

        async function deleteUser(userId) {
            if (confirm(`Are you sure you want to delete user ${userId}? Note: You will need to manually delete this user from Firebase Authentication in the Firebase Console.`)) {
                try {
                    await db.collection('users').doc(userId).delete();
                    loadDashboardData();
                    showNotification('User deleted from Firestore. Please delete the user from Firebase Authentication manually.');
                } catch (error) {
                    showNotification('Failed to delete user from Firestore: ' + error.message);
                }
            }
        }

        // Profile
        async function renderProfile() {
            try {
                const userId = currentUser.username.split('@')[0];
                const userDoc = await db.collection('users').doc(userId).get();
                const profile = userDoc.data();
                document.getElementById('profile-username').value = currentUser.username;
                document.getElementById('profile-role').value = profile.role;
                document.getElementById('profile-email').value = profile.email || currentUser.username;
            } catch (error) {
                showNotification('Failed to load profile: ' + error.message);
            }
        }

        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('change-password').value;
            const newEmail = document.getElementById('profile-email').value;
            const userId = currentUser.username.split('@')[0];

            try {
                if (newPassword) {
                    await auth.currentUser.updatePassword(newPassword);
                    showNotification('Password updated successfully');
                }
                if (newEmail && newEmail !== currentUser.username) {
                    await auth.currentUser.updateEmail(newEmail);
                    await db.collection('users').doc(userId).update({ email: newEmail });
                    currentUser.username = newEmail;
                    showNotification('Email updated successfully');
                }
                loadDashboardData();
            } catch (error) {
                showNotification('Failed to update profile: ' + error.message);
            }
        });

        // Theme Toggle
        document.getElementById('theme-toggle').addEventListener('change', (e) => {
            const theme = e.target.value;
            document.body.classList.toggle('light-theme', theme === 'light');
            localStorage.setItem('theme', theme);
        });

        // Export Report
        async function exportReport() {
            const reportType = document.getElementById('report-type').value;
            const month = document.getElementById('report-month').value;
            const qa = document.getElementById('report-qa').value;
            const projectFilter = document.getElementById('report-project').value.toLowerCase();

            try {
                let reportData;
                const usersSnap = await db.collection('users').get();
                const users = Object.fromEntries(usersSnap.docs.map(doc => [doc.id, doc.data()]));

                if (reportType === 'monthly') {
                    const projectsSnap = await db.collection('projects').get();
                    const projects = projectsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const approvedSnap = await db.collection('approvedProjects').get();
                    const approvedProjects = approvedSnap.docs.map(doc => doc.data());
                    reportData = projects
                        .filter(p => !projectFilter || p.name.toLowerCase().includes(projectFilter))
                        .filter(p => !qa || p.assignedQA === qa)
                        .filter(p => !month || p.start.startsWith(month))
                        .map(p => ({
                            'Project Name': p.name,
                            'Category': p.category,
                            'QA': users[p.assignedQA]?.name || 'N/A',
                            'HTML Bugs': p.htmlBugs,
                            'Functional Bugs': p.funcBugs,
                            'Total Bugs': p.bugs,
                            'Phase': p.phase,
                            'Live Approved': approvedProjects.some(a => a.projectId === p.id) ? 'Yes' : 'No',
                            'Testing Days': Math.ceil((new Date(p.end) - new Date(p.start)) / (1000 * 60 * 60 * 24))
                        }));
                } else if (reportType === 'rejected') {
                    const rejectedSnap = await db.collection('rejectedProjects').get();
                    const rejectedProjects = rejectedSnap.docs.map(doc => doc.data());
                    reportData = rejectedProjects
                        .filter(r => !projectFilter || r.name.toLowerCase().includes(projectFilter))
                        .filter(r => !qa || r.qa === qa)
                        .filter(r => !month || r.date.startsWith(month))
                        .map(r => ({
                            'Project Name': r.name,
                            'QA': users[r.qa]?.name || 'N/A',
                            'Rejected Date': r.date,
                            'Phase': r.phase,
                            'PC': r.pc,
                            'Reason': r.reason
                        }));
                } else if (reportType ==='qa-wise') {
                    const projectsSnap = await db.collection('projects').get();
                    const projects = projectsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const approvedSnap = await db.collection('approvedProjects').get();
                    const approvedProjects = approvedSnap.docs.map(doc => doc.data());
                    const rejectedSnap = await db.collection('rejectedProjects').get();
                    const rejectedProjects = rejectedSnap.docs.map(doc => doc.data());

                    // Group projects by QA
                    const qaReport = {};
                    projects.forEach(p => {
                        if (!qa || p.assignedQA === qa) {
                            if (!qaReport[p.assignedQA]) {
                                qaReport[p.assignedQA] = {
                                    totalProjects: 0,
                                    totalBugs: 0,
                                    htmlBugs: 0,
                                    funcBugs: 0,
                                    approved: 0,
                                    rejected: 0
                                };
                            }
                            qaReport[p.assignedQA].totalProjects += 1;
                            qaReport[p.assignedQA].totalBugs += p.bugs || 0;
                            qaReport[p.assignedQA].htmlBugs += p.htmlBugs || 0;
                            qaReport[p.assignedQA].funcBugs += p.funcBugs || 0;
                            if (approvedProjects.some(a => a.projectId === p.id)) {
                                qaReport[p.assignedQA].approved += 1;
                            }
                            if (rejectedProjects.some(r => r.projectId === p.id)) {
                                qaReport[p.assignedQA].rejected += 1;
                            }
                        }
                    });

                    reportData = Object.keys(qaReport).map(qaId => ({
                        'QA': users[qaId]?.name || 'Unknown',
                        'Total Projects': qaReport[qaId].totalProjects,
                        'Total Bugs': qaReport[qaId].totalBugs,
                        'HTML Bugs': qaReport[qaId].htmlBugs,
                        'Functional Bugs': qaReport[qaId].funcBugs,
                        'Approved Projects': qaReport[qaId].approved,
                        'Rejected Projects': qaReport[qaId].rejected
                    }));
                }

                // Export to CSV using Papa Parse
                if (reportData.length > 0) {
                    const csv = Papa.unparse(reportData);
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `${reportType}-report-${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showNotification('Report exported successfully');
                } else {
                    showNotification('No data available for the selected filters');
                }
            } catch (error) {
                showNotification('Failed to export report: ' + error.message);
            }
        }

        // Table Sorting
        function sortTable(tableId, colIndex) {
            const table = document.getElementById(tableId);
            let rows = Array.from(table.rows);
            const isNumeric = rows.every(row => !isNaN(parseFloat(row.cells[colIndex].textContent)) || row.cells[colIndex].textContent === 'N/A');
            const direction = table.dataset.sortDirection === 'asc' ? 'desc' : 'asc';
            table.dataset.sortDirection = direction;

            rows.sort((a, b) => {
                let aValue = a.cells[colIndex].textContent.trim();
                let bValue = b.cells[colIndex].textContent.trim();

                // Handle 'N/A' values
                if (aValue === 'N/A') return 1;
                if (bValue === 'N/A') return -1;

                if (isNumeric) {
                    aValue = parseFloat(aValue) || 0;
                    bValue = parseFloat(bValue) || 0;
                    return direction === 'asc' ? aValue - bValue : bValue - aValue;
                } else {
                    return direction === 'asc' ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                }
            });

            table.innerHTML = '';
            rows.forEach(row => table.appendChild(row));
        }

        // Check for Due Tasks and Send Alerts (Simulated)
        async function checkDueTasks() {
            try {
                const tasksSnap = await db.collection('tasks').where('status', '==', 'inprogress').get();
                const tasks = tasksSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const today = new Date();
                tasks.forEach(async task => {
                    const dueDate = new Date(task.dueDate);
                    const timeDiff = dueDate - today;
                    if (timeDiff <= 24 * 60 * 60 * 1000 && timeDiff > 0 && !task.alertSent) {
                        // Simulate sending an alert (e.g., email or notification)
                        console.log(`Alert: Task "${task.name}" for ${task.assignee} is due soon on ${task.dueDate}`);
                        await db.collection('tasks').doc(task.id).update({ alertSent: true });
                    }
                });
            } catch (error) {
                console.error('Error checking due tasks:', error);
            }
        }

        // Run due task check on load
        document.addEventListener('DOMContentLoaded', () => {
            checkDueTasks();
        });

        // Accessibility: Close modals with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }
        });

        // Ensure Firestore Security Rules Compatibility
        // Note: The Firestore security rules should be set as follows in the Firebase Console:
        /*
        rules_version = '2';
        service cloud.firestore {
            match /databases/{database}/documents {
                match /users/{userId} {
                    allow read: if request.auth != null;
                    allow write: if request.auth != null && request.auth.uid == userId || request.auth.token.role == 'Team Lead';
                }
                match /projects/{projectId} {
                    allow read: if request.auth != null;
                    allow write: if request.auth != null && request.auth.token.role == 'Team Lead';
                }
                match /tasks/{taskId} {
                    allow read: if request.auth != null;
                    allow write: if request.auth != null && (request.auth.token.role == 'Team Lead' || resource.data.assignee == request.auth.uid);
                }
                match /approvedProjects/{projectId} {
                    allow read: if request.auth != null;
                    allow write: if request.auth != null && request.auth.token.role == 'Team Lead';
                }
                match /rejectedProjects/{projectId} {
                    allow read: if request.auth != null;
                    allow write: if request.auth != null && request.auth.token.role == 'Team Lead';
                }
                match /activityLog/{logId} {
                    allow read: if request.auth != null;
                    allow write: if request.auth != null;
                }
            }
        }
        */
        // Ensure these rules are applied in the Firebase Console to match the app's functionality.

    </script>
</body>
</html>
